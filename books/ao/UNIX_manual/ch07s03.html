<html>

<!-- Mirrored [from host tinco.pair.com [file /bhaskar/gtm/doc/books/ao/UNIX_manual/ch07s03.html]] -->
<HEAD><META HTTP-EQUIV="Pragma" CONTENT="no-cache"><META HTTP-EQUIV="Expires" CONTENT="-1">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Procedures</title>
<link rel="stylesheet" href="gtm.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
<link rel="home" href="index.html" title="GT.M Administration and Operations Guide">
<link rel="up" href="ch07.html" title="Chapter 7. Database Replication">
<link rel="prev" href="ch07s02.html" title="Implementing Replication and Recovery">
<link rel="next" href="replication.html" title="Commands and Qualifiers">
<link rel="copyright" href="ln-idp178646624.html" title="Legal Notice">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">Procedures</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch07s02.html">Prev</a> </td>
<th width="60%" align="center">Chapter 7. Database Replication</th>
<td width="20%" align="right"> <a accesskey="n" href="replication.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">GT.M Administration and Operations Guide</a></span> &gt; <span class="breadcrumb-link"><a href="ch07.html">Database Replication</a></span> &gt; <span class="breadcrumb-node">Procedures</span>
</div>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="procedure"></a>Procedures</h2></div></div></div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="downld_repl_ex"></a>Download Replication Examples</h3></div></div></div>
<p><code class="code"><span class="bold"><strong>repl_procedures.tar.gz</strong></span></code> contains a set of replication example scripts. Each script contains a combination of GT.M commands that accomplish a specific task. All examples in the Procedures section use these replication scripts but each example uses different script sequence and script arguments. Always run all replication examples in a test system from a new directory as they create sub-directories and database files in the current directory. No claim of copyright is made with regard to these examples. These example scripts are for explanatory purposes and are not intended for production use. <span class="bold"><strong></strong></span>YOU MUST UNDERSTAND, AND APPROPRIATELY ADJUST THE COMMANDS GIVEN IN THESE SCRIPTS BEFORE USING IN A PRODUCTION ENVIRONMENT.<span class="bold"><strong></strong></span> Typically, you would set replication between instances on different systems/data centers and create your own set of scripts with appropriate debugging and error handling to manage replication between them. Click <a class="ulink" href="downloadables/repl_procedures.tar.gz" target="_top"><span class="inlinemediaobject"><img src="images/download.html" alt="Download repl_procedures.tar.gz"></span></a> to download <code class="code"><span class="bold"><strong>repl_procedures.tar.gz</strong></span></code> on a test system. </p>
<p><code class="code"><span class="bold"><strong>repl_procedures.tar.gz</strong></span></code> includes the following scripts:</p>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="procenv"></a>env</h4></div></div></div>
<p>Sets a default environment for GT.M replication. It take two arguments: </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">The name of the instance/database directory.</li>
<li class="listitem">The GT.M version. </li>
</ul></div>
<p>Example: <code class="code">source ./env A V6.3-000A_x86_64</code></p>
<p>Here is the code:</p>
<pre class="programlisting">
export gtm_dist=/usr/lib/fis-gtm/$2
export gtm_repl_instname=$1
export gtm_repl_instance=$PWD/$gtm_repl_instname/gtm.repl
export gtmgbldir=$PWD/$gtm_repl_instname/gtm.gld
export gtm_principal_editing=EDITING
export gtmroutines="$PWD/$gtm_repl_instname $gtm_dist"
#export gtmroutines="$PWD/$gtm_repl_instname $gtm_dist/libgtmutil.so"
# Here is an example of setting the gtmroutines environment variable:
# if [ -e  "$gtm_dist/libgtmutil.so" ] ; then export gtmroutines="$PWD/$gtm_repl_instname $gtm_dist/libgtmutil.so"
else export gtmroutines="$PWD/$gtm_repl_instname* $gtm_dist" ; fi
# For more examples on setting GT.M related environment variables to reasonable values on POSIX shells, refer to the gtmprofile script.
#export LD_LIBRARY_PATH=/usr/local/lib
#export gtmcrypt_config=$PWD/$gtm_repl_instname/config_file
#echo -n "Enter Password for gtmtls_passwd_${gtm_repl_instname}: ";export gtmtls_passwd_${gtm_repl_instname}="`$gtm_dist/plugin/gtmcrypt/maskpass|tail -n 1|cut -f 3 -d " "`"</pre>
<p>Modify the env script according to your test environment. </p>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="dbcreateproc"></a>db_create</h4></div></div></div>
<p>Creates a new sub-directory in the current directory, a global directory file with settings from gdemsr, and the GT.M database file. </p>
<p>Here is the code:</p>
<pre class="programlisting">mkdir -p $PWD/$gtm_repl_instname/
  $gtm_dist/mumps -r ^GDE @gdemsr
  $gtm_dist/mupip create</pre>
<p><code class="code">gdemsr</code> contains:</p>
<pre class="programlisting">change -segment DEFAULT -file_name=$PWD/$gtm_repl_instname/gtm.dat
  exit</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="backupreplproc"></a>backup_repl</h4></div></div></div>
<p>Creates a backup of the replication instance file. The first argument specifies the location of the backed up replication instance file. </p>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip backup -replinst=$1</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="replsetupproc"></a>repl_setup</h4></div></div></div>
<p>Turns on replication for all regions and create the replication instance file with the -noreplace qualifier for a BC instance. </p>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip set -replication=on -region "*"
  $gtm_dist/mupip replicate -instance_create -noreplace</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="originstartproc"></a>originating_start</h4></div></div></div>
<p>Starts the Source Server of the originating instance in a BC replication configuration. It takes five arguments:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">The first argument is the name of the originating instance. This argument is also used in the name of the Source Server log file. </li>
<li class="listitem">The second argument is the name of the BC replicating instance. This argument is also used in the name of the Source Server log file.</li>
<li class="listitem">The third argument is port number of localhost at which the Receiver Server is waiting for a connection. </li>
<li class="listitem">The optional fourth and fifth argument specify the -tlsid and -reneg qualifiers used to set up a TLS/SSL connection.</li>
<li class="listitem">Example:<code class="code">./originating_start A B 4001</code>
</li>
</ul></div>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip replicate -source -start -instsecondary=$2 -secondary=localhost:$3 -buffsize=1048576 -log=$PWD/$1/$1_$2.log $4 $5
tail -30 $PWD/$1/$1_$2.log
$gtm_dist/mupip replicate -source -checkhealth</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="replstartproc"></a>replicating_start</h4></div></div></div>
<p>Starts the passive Source Server and the Receiver Server in a BC replication configuration. It takes four arguments:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">The first argument is the name of the replicating instance. This argument is also used in the name of the passive Source Server and Receiver Server log file name. </li>
<li class="listitem">The second argument is port number of localhost at which the Source Server is sending the replication stream for the replicating instance. </li>
<li class="listitem">The optional third and fourth arguments are used to specify additional qualifiers for the Receiver Server startup command. </li>
<li class="listitem">Example:<code class="code">./replicating_start B 4001</code>
</li>
</ul></div>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip replicate -source -start -passive -instsecondary=dummy -buffsize=1048576 -log=$PWD/$1/source$1_dummy.log # creates the Journal Pool
$gtm_dist/mupip replicate -receive -start -listenport=$2 -buffsize=1048576 -log=$PWD/$1/receive.log $3 $4 # starts the Receiver Server
tail -20 $PWD/$1/receive.log
$gtm_dist/mupip replicate -receive -checkhealth</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="supplsetupproc"></a>suppl_setup</h4></div></div></div>
<p>Turns on replication for all regions, create the supplementary replication instance file with the -noreplace qualifier, starts the passive Source Server, starts the Receiver Server of an SI replicating instance, and displays the health status of the Receiver Server and Update Process. Use this to start an SI replicating instance for the first time. It takes four arguments:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">The first argument is the name of the supplementary instance. This argument is also used in the name of the passive Source Server and Receiver Server log files. </li>
<li class="listitem">The second argument is the path to the backed up replication instance file of the originating instance. </li>
<li class="listitem">The third argument is port number of localhost at which the Receiver Server is waiting for a connection. </li>
<li class="listitem">The optional fourth argument is either -updok or -updnotok which determines whether the instance accepts updates. </li>
<li class="listitem">The optional fifth argument specifies -tlsid which is used in setting up a TLS/SSL replication connection.  </li>
</ul></div>
<p>Example: <code class="code">./suppl_setup P startA 4011 -updok</code></p>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip set -replication=on -region "*"
$gtm_dist/mupip replicate -instance_create -supplementary -noreplace
$gtm_dist/mupip replicate -source -start -passive -buf=1048576 -log=$PWD/$gtm_repl_instname/$1_dummy.log -instsecondary=dummy $4
$gtm_dist/mupip replicate -receive -start -listenport=$3 -buffsize=1048576 -log=$PWD/$gtm_repl_instname/$1.log -updateresync=$2 -initialize $5
tail -30 $PWD/$1/$1.log
$gtm_dist/mupip replicate -receive -checkhealth</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="replstatusproc1"></a>repl_status</h4></div></div></div>
<p>Displays health and backlog status information for the Source Server and Receiver Server in the current environment.</p>
<p>Here is the code:</p>
<pre class="programlisting">echo "-----------------------------------------------------------------"
  echo "Source Server $gtm_repl_instname: "
  echo "-----------------------------------------------------------------"
  $gtm_dist/mupip replicate -source -check
  $gtm_dist/mupip replicate -source -showbacklog
  echo "-----------------------------------------------------------------"
  echo "Receiver Server $gtm_repl_instname: "
  echo "-----------------------------------------------------------------"
  $gtm_dist/mupip replicate -receive -check
  $gtm_dist/mupip replicate -rece -showbacklog</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="rollbackproc11"></a>rollback</h4></div></div></div>
<p>Performs an ONLINE FETCHRESYNC rollback and creates a lost and/or broken transaction file. It takes two arguments:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">The first argument specifies the communication port number that the rollback command uses when fetching the reference point. This is the same port number that the Receiver Server used to communicate with the Source Server.</li>
<li class="listitem">The second argument specifies either <code class="code">backward</code> or <code class="code">forward</code>.</li>
</ul></div>
<p>Example: <code class="code">./rollback 4001 backward</code></p>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip journal -rollback -fetchresync=$1 -$2 "*"</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="originstop"></a>originating_stop</h4></div></div></div>
<p>Shuts down the Source Server with a two second timeout and perform a MUPIP RUNDOWN operation.</p>
<p>The first argument specifies additional qualifiers for the Source Server shutdown command.</p>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip replicate -source -shutdown -timeout=2 $1 #Shut down the originating Source Server
  $gtm_dist/mupip rundown -region "*" #Perform database rundown</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="replstopproc"></a>replicating_stop</h4></div></div></div>
<p>Shuts down the Receiver Server with a two seconds timeout and then shuts down the passive Source Server. </p>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip replicate -receiver -shutdown -timeout=2 #Shut down the Receiver Server
  $gtm_dist/mupip replicate -source -shutdown -timeout=2 #Shut down the passive Source Server</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="replstartsuppproc"></a>replicating_start_suppl_n</h4></div></div></div>
<p>Starts the passive Source Server and the Receiver Server of the supplementary instance for all startups except the first. It takes three arguments:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">The first argument is the name of the supplementary instance. It is also used in the names of the passive Source Server and the Receiver Server log files. </li>
<li class="listitem">The second argument is port number of localhost at which the Receiver Server is waiting for a connection. </li>
<li class="listitem">The optional third argument is an additional qualifier for the passive Source Server startup command. In the examples, the third argument is either <code class="code">-updok</code> or <code class="code">-updnotok</code>.</li>
<li class="listitem">The optional fourth argument is an additional qualifier for the Receiver Server startup command. In the examples, the fourth argument is either <code class="code">-autorollback</code> or <code class="code">-noresync</code>.</li>
<li class="listitem">The optional fifth argument is -tlsid which is used to set up a TLS/SSL replication connection.</li>
</ul></div>
<p>Example:<code class="code">./replicating_start_suppl_n P 4011 -updok -noresync</code></p>
<p>Here is the code:</p>
<pre class="programlisting">$gtm_dist/mupip replicate -source -start -passive -instsecondary=dummy -buffsize=1048576 -log=$PWD/$gtm_repl_instname/$12dummy.log $3 # creates the Journal Pool
  $gtm_dist/mupip replicate -receive -start -listenport=$2 -buffsize=1048576 $4 $5 -log=$PWD/$gtm_repl_instname/$1.log # starts the Receiver Server and the Update Process
  tail -30 $PWD/$1/$1.log
  $gtm_dist/mupip replicate -receiver -checkhealth # Checks the health of the Receiver Server and the Update Process</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="gengcproc"></a>gen_gc</h4></div></div></div>
<p>Creates the libconfig format configuration file for use with the TLS example.</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">The first second argument specify the names of all participating instances.  </li></ul></div>
<p>Example:<code class="code">./gen_gc Helen Phil</code></p>
<p>Here is the code:</p>
<pre class="programlisting">#Creates the libconfig format configuration file
  #$gtm_dist/mumps -r CONVDBKEYS $gtmcrypt_config
  echo "tls: {"&gt;$gtmcrypt_config
  echo " verify-depth: 7;" &gt;&gt; $gtmcrypt_config
  echo "    CAfile: "$PWD/certs/ca.crt";" &gt;&gt; $gtmcrypt_config
  echo "     $1: {" &gt;&gt; $gtmcrypt_config
  echo "           format: "PEM";" &gt;&gt; $gtmcrypt_config
  echo "           cert: "$PWD/certs/$1.crt";" &gt;&gt; $gtmcrypt_config
  echo "           key: "$PWD/certs/$1.key";" &gt;&gt; $gtmcrypt_config
  echo "     };" &gt;&gt; $gtmcrypt_config
  echo "     $2: {" &gt;&gt; $gtmcrypt_config
  echo "           format: "PEM";" &gt;&gt; $gtmcrypt_config
  echo "           cert: "$PWD/certs/$2.crt";" &gt;&gt; $gtmcrypt_config
  echo "           key: "$PWD/certs/$2.key";" &gt;&gt; $gtmcrypt_config
  echo "     };" &gt;&gt; $gtmcrypt_config
  echo "};" &gt;&gt; $gtmcrypt_config</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="certsetupproc"></a>cert_setup</h4></div></div></div>
<p>Sets up the $PWD/certs directory for use with the TLS example.</p>
<p>Here is the code:</p>
<pre class="programlisting">echo "Creating cert directories ...in $PWD"
  mkdir -p $PWD/certs/newcerts
  touch $PWD/certs/index.txt
  echo "01" &gt; $PWD/certs/serial
  echo "Generating root CA...."
  ./gen_ca
  </pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="gencaproc"></a>gen_ca</h4></div></div></div>
<p>Creates the root certification authority in the $PWD/certs directory for use with the TLS example.</p>
<p>Here is the code:</p>
<pre class="programlisting">#Generates root certification authority and sets it to expire in 365 days. Ensure that you have a properly configured /etc/ssl/openssl.cnf file.
  mkdir -p $PWD/certs
  openssl genrsa -des3 -out $PWD/certs/$1ca.key
  openssl req -new -x509 -days 365 -key $PWD/certs/$1ca.key -out $PWD/certs/$1ca.crt
  #Important: Keep the self-signed root certificate authority and leaf-level certificates in a secure location. Protect their directories with 0500 permissions and the individual files with 0400 permissions so that unauthorized users cannot access them.</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="genleafproc"></a>gen_leaf</h4></div></div></div>
<p>Creates the leaf-level certificate and gets it signed from the root certification authority for use with the TLS example.</p>
<p>Here is the code:</p>
<pre class="programlisting">#Generates leaf-level certificates in $PWD/certs
openssl genrsa -des3 -out $PWD/certs/$1${gtm_repl_instname}.key
openssl req -new -key $PWD/certs/$1${gtm_repl_instname}.key -out $PWD/certs/$gtm_repl_instname.csr
openssl ca -config $PWD/openssl.cnf -in $PWD/certs/$gtm_repl_instname.csr -out $PWD/certs/$1$gtm_repl_instname.crt
openssl x509 -in $PWD/certs/$1$gtm_repl_instname.crt -dates -issuer -subject -noout</pre>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="abrepl1"></a>Setting up an A&#8594;B replication configuration with empty databases</h3></div></div></div>
<p>On A:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Turn on replication.</p></li>
<li class="listitem"><p>Create the replication instance file.</p></li>
<li class="listitem"><p>Start the Source Server.</p></li>
</ul></div>
<p>On B:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Turn on replication.</p></li>
<li class="listitem"><p>Create a new replication instance file.</p></li>
<li class="listitem"><p>Start the passive Source Server.</p></li>
<li class="listitem"><p>Start the Receiver Server.</p></li>
</ul></div>
<p>Example:</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64 
./db_create
./repl_setup
./originating_start A B 4001
source ./gtmenv B V6.3-000A_x86_64
./db_create
./repl_setup
./replicating_start B 4001
./repl_status</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv B V6.3-000A_x86_64
./replicating_stop
source ./env A V6.3-000A_x86_64
./originating_stop</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="abcrepl1"></a>Setting up an A&#8594;B&#8594;C replication configuration with empty databases</h3></div></div></div>
<p>On A:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Turn on replication.</p></li>
<li class="listitem"><p>Create the replication instance file.</p></li>
<li class="listitem"><p>Start the Source Server.</p></li>
</ul></div>
<p>On B:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Turn on replication.</p></li>
<li class="listitem"><p>Create a new replication instance file.</p></li>
<li class="listitem"><p>Start the passive Source Server. </p></li>
<li class="listitem"><p>Start the Receiver Server.</p></li>
<li class="listitem"><p>Start the Source Server with the -propagateprimary qualifier.</p></li>
</ul></div>
<p>On C:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Turn on replication.</p></li>
<li class="listitem"><p>Create a new replication instance file.</p></li>
<li class="listitem"><p>Start the passive Source Server .</p></li>
<li class="listitem"><p>Start the Receiver Server.</p></li>
</ul></div>
<p>Example:</p>
<pre class="programlisting">
source ./gtmenv A V6.3-000A_x86_64 
./db_create
./repl_setup
./originating_start A B 4001
source ./gtmenv B V6.3-000A_x86_64
./db_create
./repl_setup
./replicating_start B 4001
./originating_start B C 4002 -propagateprimary
source ./gtmenv C V6.3-000A_x86_64
./db_create
./repl_setup
./replicating_start C 4002
./repl_status</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv C V6.3-000A_x86_64
./replicating_stop
source ./gtmenv B V6.3-000A_x86_64
./replicating_stop
./originating_stop
source ./gtmenv A V6.3-000A_x86_64
./originating_stop</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="aprepl"></a>Setting up an A&#8594;P replication configuration with empty databases</h3></div></div></div>
<p>On A:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Turn on replication.</p></li>
<li class="listitem"><p>Create a new replication instance file.</p></li>
<li class="listitem"><p>Start the Source Server.</p></li>
<li class="listitem">
<p>Immediately, after starting the Source Server but before making any updates, take a backup of the replication instance file. The instance file has the journal sequence number that corresponds to the database state at the time of starting the instance. This backup instance helps when you need to start a new Supplementary Instance without taking a backup of the Originating Instance. Retain the backup copy of the Originating Instance as you may need it in future as a checkpoint from where its supplementary instance may resume to receive updates. </p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Note]" src="images/note.html"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>While a backed up instance file helps start replication on the P side of A&#8594;P, it does not prevent the need for taking a backup of the database on A. You need to do a database backup/restore or an extract/load from A to P to ensure P has all of the data as on A at startup.</p></td></tr>
</table></div>
</li>
</ul></div>
<p>On P:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Turn on replication.</p></li>
<li class="listitem"><p>Create a new replication instance file with the -supplementary qualifier.</p></li>
<li class="listitem"><p>Start the passive Source Server.</p></li>
<li class="listitem"><p>Start the Receiver Server and the Update Process with -updateresync="/path/to/bkup_orig_repl_inst_file" -initialize. Use the -updateresync -initialize qualifiers only once.</p></li>
<li class="listitem"><p>For subsequent Receiver Server and Update Process start ups, do not use -updateresync -initialize with qualifiers. Either use -autorollback with the Receiver Server startup command or perform an explicit -fetchresync -rollback before starting the Receiver Server. </p></li>
</ul></div>
<p>Example:</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./db_create
./repl_setup
./originating_start A P 4000
./backup_repl startA
source ./gtmenv P V6.3-000A_x86_64
./db_create
./suppl_setup P startA 4000 -updok
./repl_status
# For subsequent Receiver Server startup for P, use:
# ./replicating_start_suppl_n P 4000 -updok -autorollback
# or 
#./rollback 4000 backward
#./replicating_start_suppl_n P 4000 -updok</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv P V6.3-000A_x86_64
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
./originating_stop</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="riborg"></a>Replicating Instance Starts from Backup of Originating Instance (A&#8594;B and A&#8594;P )</h3></div></div></div>
<p>The more common scenario for bringing up a replicating instance is to take a backup of the originating instance and bring it up as a replicating instance. If the backup is a comprehensive backup, the file headers store the journal sequence numbers.</p>
<p>On A:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Create a backup using -DATABASE, -REPLINST, -NEWJNLFILE=PREVLINK, and -BKUPDBJNL=DISABLE qualifiers. -DATABASE creates a comprehensive backup of the database file. -REPLINST backs up the replication instance file. -BKUPDBJNL=DISABLE scrubs all journal file information in the backup database file.  As the backup of instance A is comprehensive, -NEWJNLFILE=PREVLINK cuts the back link to prior generation journal files of the database for which you are taking the backup. </p></li>
<li class="listitem"><p>Copy the backup of the replication instance file to the location of the backed up instance. </p></li>
<li class="listitem"><p>Start a new Source Server for the backed up replicating instance. </p></li>
</ul></div>
<p>On the backed up instance:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Load/restore the database. If the replicating database is not from a comprehensive or database backup from the originating instance, set the journal sequence number from the originating at the instant of the backup for at least one replicated region on the replicating instance.</p></li>
<li class="listitem"><p>Run MUPIP REPLICATE -EDITINSTANCE command to change the name of the backed up replication instance file.</p></li>
<li class="listitem"><p>Start the Receiver Server for the BC replicating instance.  Do not use the -UPDATERESYNC qualifier to start the receiver server of a BC replicating instance. -UPDATERESYNC is necessary when you start the Receiver Server of a SI replicating instance for the first time. Without -UDPATERESYNC, the SI replicating instance may refuse to start replication because the journal sequence number in the replicating instance may be higher than what the originating instance expects.</p></li>
</ul></div>
<p>Example:</p>
<p>The following example demonstrates starting a replicating instance from the backup of an originating instance in an A&#8594;B replication configuration. Note that you do not need to perform an -updateresync when starting a BC replicating instance for the first time. </p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./db_create
./repl_setup
./originating_start A backupA 4001
./backup_repl startingA   #Preserve the backup of the replicating instance file that represents the state at the time of starting the instance. 
$gtm_dist/mumps -r %XCMD 'for i=1:1:10 set ^A(i)=i'
mkdir backupA   
$gtm_dist/mupip backup -replinst=currentstateA -newjnlfile=prevlink -bkupdbjnl=disable DEFAULT backupA
source ./gtmenv backupA V6.3-000A_x86_64
./db_create
./repl_setup
cp currentstateA backupA/gtm.repl
$gtm_dist/mupip replicate -editinstance -name=backupA backupA/gtm.repl 
./replicating_start backupA 4001 
./repl_status</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv backupA V6.3-000A_x86_64
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
./originating_stop</pre>
<p>The following example demonstrates starting a replicating instance from the backup of an originating instance in an A&#8594;P replication configuration. Note that you need to perform an -updateresync to start a supplementary instance for the first time. </p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./db_create
./repl_setup
./originating_start A backupA 4011
./backup_repl startingA   
$gtm_dist/mumps -r %XCMD 'for i=1:1:10 set ^A(i)=i'
./backup_repl currentstateA
mkdir backupA
$gtm_dist/mupip backup -newjnlfile=prevlink -bkupdbjnl=disable DEFAULT backupA
source ./gtmenv backupA V6.3-000A_x86_64
./db_create
./suppl_setup backupA currentstateA 4011 -updok
./repl_status</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv backupA V6.3-000A_x86_64
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
./originating_stop</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="nrml_cutov"></a>Switchover possibilities in an A&#8594;B replication configuration</h3></div></div></div>
<p>A switchover is the procedure of switching the roles of an originating instance and a replicating instance. A switchover is necessary for various reasons including (but not limited to) testing the replicating instance preparedness to take over the role of an originating instance or bringing the originating instance down for maintenance in a way that there is minimal impact on application availability.</p>
<p>In an A-&gt;B replication configuration, at any given point there can be two possibilities: </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>A is ahead of B, that is A has updates which are not yet replicated to B. </p></li>
<li class="listitem"><p>A and B are in sync. This happens where there are no new updates on A and all pending updates are replicated to B. </p></li>
</ul></div>
<p>The steps described in this section perform a switchover (A-&gt;B becomes B-&gt;A) under both these possibilities. When A is ahead of B, these steps generate a lost transaction file which must be applied to the new originating instance as soon as possible. The lost transaction file contains transactions which are were not replicated to B. Apply the lost transactions on the new originating instance either manually or in a semi-automated fashion using the M-intrinsic function $ZQGBLMOD(). If you use $ZQGBLMOD(), perform two additional steps (mupip replicate -source -needrestart and mupip replicate -source -losttncomplete) as part of lost transaction processing. Failure to run these steps can cause $ZQGBLMOD() to return false negatives that in turn can result in application data consistency issues.</p>
<p>First, choose a time when there are no database updates or the rate of updates are low to minimize the chances that your application may time out. There may be a need to hold database updates briefly during the switchover. For more information on holding database updates, refer to Instance Freeze section to configure an appropriate freezing mechanism suitable for your environment. </p>
<p>In an A&#8594;B replication configuration, follow these steps:</p>
<p>On A:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Shut down the Source Server with an appropriate timeout. The timeout should be long enough to replicate pending transactions to the replicating instance but not too long to cause clients to conclude that the application is not available. The GT.M default Source Server wait period is up to 120 seconds. In most cases, the default wait period is sufficient.</p></li></ul></div>
<p>On B:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Shut down the Receiver Server and the Update Process. </p></li>
<li class="listitem"><p>Shut down the passive Source Server to bring down the journal pool. Ensure that you shut down the Receiver Server and Update Process first before shutting down the passive Source Server.  </p></li>
<li class="listitem"><p>Start B as the new originating instance. </p></li>
</ol></div>
<p>On A:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Start the passive Source Server. </p></li>
<li class="listitem"><p>Perform a FETCHRESYNC ROLLBACK BACKWARD.</p></li>
<li class="listitem"><p>Start the Receiver Server. </p></li>
<li class="listitem"><p>Process the lost transaction file as soon as possible. </p></li>
</ol></div>
<p>The following example runs a switchover in an A&#8594;B replication configuration.</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64 # creates a simple environment for instance A
./db_create
./repl_setup # enables replication and creates the replication instance file
./originating_start A B 4001 # starts the active Source Server (A-&gt;B)
$gtm_dist/mumps -r %XCMD 'for i=1:1:100 set ^A(i)=i'
./repl_status #-SHOWBACKLOG and -CHECKHEALTH report
source ./gtmenv B V6.3-000A_x86_64 # creates a simple environment for instance B
./db_create
./repl_setup
./replicating_start B 4001 
./repl_status # -SHOWBACKLOG and -CHECKHEATH report 
./replicating_stop # Shutdown the Receiver Server and the Update Process 
source ./gtmenv A V6.3-000A_x86_64 # Creates an environment for A
$gtm_dist/mumps -r %XCMD 'for i=1:1:50 set ^losttrans(i)=i' # perform some updates when replicating instance is not available. 
sleep 2
./originating_stop # Stops the active Source Server 
source ./gtmenv B V6.3-000A_x86_64 # Create an environment for B
./originating_start B A 4001 # Start the active Source Server (B-&gt;A)
source ./gtmenv A V6.3-000A_x86_64 # Create an environment for A
./rollback 4001 backward
./replicating_start A 4001 # Start the replication Source Server 
./repl_status # To confirm whether the Receiver Server and the Update Process started correctly.
cat A/gtm.lost </pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./replicating_stop
source ./gtmenv B V6.3-000A_x86_64
./originating_stop</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="recov_bap"></a>Switchover possibilities in a B&#8592;A&#8594;P replication configuration </h3></div></div></div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="a_req_rlbk"></a>A requires rollback</h4></div></div></div>
<p>The following scenario demonstrates a switchover from B&#8592;A&#8594;P to A&#8592;B&#8594;P when A has unreplicated updates that require rollback before B can become the new originating instance.</p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>A</strong></span></p>
            </th>
<th>
              <p><span class="italic">B</span></p>
            </th>
<th>
              <p><span class="underline">P</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span></p>
            </td>
<td>
              <p><span class="bold"><strong>A</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">B</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A98</strong></span> and <span class="underline">P</span> as a SI that includes transaction number <span class="bold"><strong>A97</strong></span>, interspersed with locally generated updates. Updates are recorded in each instance's journal files using before-image journaling.</p>
            </td>
</tr>
<tr>
<td>
              <p>Crashes</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span></p>
            </td>
<td>
              <p>... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span></p>
            </td>
<td>
              <p>When an event disables <span class="bold"><strong>A</strong></span>, <span class="italic">B</span> becomes the new originating primary, with <span class="bold"><strong>A98</strong></span> as the latest transaction in its database, and starts processing application logic to maintain business continuity. In this case where <span class="underline">P</span> is not ahead of <span class="italic">B</span>, the Receiver Server at <span class="underline">P</span> can remain up after <span class="bold"><strong>A</strong></span> crashes. When <span class="italic">B</span> connects, its Source Server and <span class="underline">P</span>"s Receiver Server confirms that <span class="italic">B</span> is not behind <span class="underline">P</span> with respect to updates received from <span class="bold"><strong>A</strong></span>, and SI replication from <span class="italic">B</span> picks up where replication from <span class="bold"><strong>A</strong></span> left off.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="italic">B61</span>, <span class="underline">P40</span></p>
            </td>
<td>
              <p><span class="underline">P</span> operating as a supplementary instance to <span class="italic">B</span> replicates transactions processed on <span class="italic">B</span>, and also applies its own locally generated updates. Although <span class="bold"><strong>A98</strong></span> was originally generated on <span class="bold"><strong>A</strong></span>, <span class="underline">P</span> received it from <span class="italic">B</span> because <span class="bold"><strong>A97</strong></span> was the common point between <span class="italic">B</span> and <span class="underline">P</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="italic">B61</span>, <span class="underline">P40</span>, <span class="italic">B62</span>, <span class="italic">B63</span></p>
            </td>
<td>
              <p><span class="underline">P</span>, continuing as a supplementary instance to <span class="italic">B</span>, replicates transactions processed on <span class="italic">B</span>, and also applies its own locally generated updates. <span class="bold"><strong>A</strong></span> meanwhile has been repaired and brought online. It has to roll transaction <span class="bold"><strong>A99</strong></span> off its database into an Unreplicated Transaction Log before it can start operating as a replicating secondary instance to <span class="italic">B</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span>, B65</p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="italic">B61</span>, <span class="underline">P40</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="underline">P41</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>Having rolled off transactions into an Unreplicated Transaction Log, <span class="bold"><strong>A</strong></span> can now operate as a replicating secondary instance to <span class="italic">B</span>. This is normal BC Logical Multi-Site operation. <span class="italic">B</span> and <span class="underline">P</span> continue operating as originating primary instance and supplementary instance.</p>
            </td>
</tr>
</tbody>
</table></div>
<p>The following example creates this switchover scenario:</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^A(98)=99'
source ./gtmenv B V6.3-000A_x86_64
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^A(99)=100'
./originating_stop
source ./gtmenv B V6.3-000A_x86_64
./originating_start B A 4010
./originating_start B P 4011
./backup_repl startB
$gtm_dist/mumps -r ^%XCMD 'set ^B(61)=0'
source ./gtmenv P V6.3-000A_x86_64
./suppl_setup M startB 4011 -updok
$gtm_dist/mumps -r ^%XCMD 'for i=39:1:40 set ^P(i)=i'
source ./gtmenv B V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^B(62)=1,^B(63)=1'
source ./gtmenv A V6.3-000A_x86_64
./rollback 4010 backward
./replicating_start A 4010
source ./gtmenv B V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^B(64)=1,^B(65)=1'
cat A/gtm.lost</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv B V6.3-000A_x86_64
./originating_stop
source ./gtmenv A V6.3-000A_x86_64 
./replicating_stop
source ./gtmenv P V6.3-000A_x86_64
./replicating_stop</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="ap_req_rllbk"></a>A and P require rollback</h4></div></div></div>
<p>The following demonstrates a switchover scenario from B&#8592;A&#8594;P  to A&#8592;B&#8594;P where A and P have unreplicated updates that require rollback before B can become the new originating instance. </p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>A</strong></span></p>
            </th>
<th>
              <p><span class="italic">B</span></p>
            </th>
<th>
              <p><span class="underline">P</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="underline">P40</span></p>
            </td>
<td>
              <p><span class="bold"><strong>A</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">B</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A97</strong></span> and <span class="underline">P</span> as a SI that includes transaction number <span class="bold"><strong>A98</strong></span>, interspersed with locally generated updates. Updates are recorded in each instance's journal files using before-image journaling.</p>
            </td>
</tr>
<tr>
<td>
              <p>Crashes</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="underline">P40</span></p>
            </td>
<td>
              <p>When an event disables <span class="bold"><strong>A</strong></span>, <span class="italic">B</span> becomes the new originating primary, with <span class="bold"><strong>A97</strong></span> the latest transaction in its database. <span class="underline">P</span> cannot immediately start replicating from <span class="italic">B</span> because the database states would not be consistent - while <span class="italic">B</span> does not have <span class="bold"><strong>A98</strong></span> in its database and its next update may implicitly or explicitly depend on that absence, <span class="underline">P</span> does, and may have relied on <span class="bold"><strong>A98</strong></span> to compute <span class="underline">P39</span> and <span class="underline">P40</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="italic">B61</span></p>
            </td>
<td>
              <p>For <span class="underline">P</span> to accept replication from <span class="italic">B</span>, it must roll off transactions generated by <span class="bold"><strong>A</strong></span>, (in this case <span class="bold"><strong>A98</strong></span>) that <span class="italic">B</span> does not have in its database, as well as any additional transactions generated and applied locally since transaction number <span class="bold"><strong>A98</strong></span> from <span class="bold"><strong>A</strong></span>.<sup>[<a name="idp184478528" href="#ftn.idp184478528" class="footnote">a</a>]</sup> This rollback is accomplished with a MUPIP JOURNAL -ROLLBACK -FETCHRESYNC operation on <span class="underline">P</span>.<sup>[<a name="idp184485648" href="#ftn.idp184485648" class="footnote">b</a>]</sup> These rolled off transactions (<span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="underline">P40</span>) go into the Unreplicated Transaction Log and can be subsequently reprocessed by application code.<sup>[<a name="idp184479792" href="#ftn.idp184479792" class="footnote">c</a>]</sup> Once the rollback is completed, <span class="underline">P</span> can start accepting replication from <span class="italic">B</span>.<sup>[<a name="idp184492096" href="#ftn.idp184492096" class="footnote">d</a>]</sup> <span class="italic">B</span> in its Originating Primary role processes transactions and provides business continuity, resulting in transactions <span class="italic">B61</span> and <span class="italic">B62</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="underline">P39</span>a, <span class="underline">P40</span>a, <span class="italic">B63</span></p>
            </td>
<td>
              <p><span class="underline">P</span> operating as a supplementary instance to <span class="italic">B</span> replicates transactions processed on <span class="italic">B</span>, and also applies its own locally generated updates. Note that <span class="underline">P39</span>a &amp; <span class="underline">P40</span>a may or may not be the same updates as the <span class="underline">P39</span> &amp; <span class="underline">P40</span> previously rolled off the database.</p>
            </td>
</tr>
</tbody>
<tbody class="footnotes"><tr><td colspan="4">
<div class="footnote"><p><sup>[<a name="ftn.idp184478528" href="#idp184478528" class="para">a</a>] </sup>As this rollback is more complex, may involve more data than the regular LMS rollback, and may involve reading journal records sequentially; it may take longer.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.idp184485648" href="#idp184485648" class="para">b</a>] </sup>In scripting for automating operations, there is no need to explicitly test whether <span class="italic">B</span> is behind <span class="underline">P</span> - if it is behind, the Source Server will fail to connect and report an error, which automated shell scripting can detect and effect a rollback on <span class="underline">P</span> followed by a reconnection attempt by <span class="italic">B</span>. On the other hand, there is no harm in <span class="underline">P</span> routinely performing a rollback before having <span class="italic">B</span> connect - if it is not ahead, the rollback will be a no-op. This characteristic of replication is unchanged from releases prior to V5.5-000.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.idp184479792" href="#idp184479792" class="para">c</a>] </sup>GT.M's responsibility for them ends once it places them in the Unreplicated Transaction Log.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.idp184492096" href="#idp184492096" class="para">d</a>] </sup>Ultimately, business logic must determine whether the rolled off transactions can simply be reapplied or whether other reprocessing is required. GT.M's $ZQGBLMOD() function can assist application code in determining whether conflicting updates may have occurred.</p></div>
</td></tr></tbody>
</table></div>
<p>The following example creates this scenario.</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./db_create
./repl_setup
./originating_start A B 4010
./originating_start A P 4011
./backup_repl startA
$gtm_dist/mumps -r ^%XCMD 'for i=1:1:97 set ^A(i)=i'
source ./gtmenv B V6.3-000A_x86_64
./db_create
./repl_setup
./replicating_start B 4010
source ./gtmenv P V6.3-000A_x86_64
./db_create
./suppl_setup P startA 4011 -updok
$gtm_dist/mumps -r ^%XCMD 'for i=1:1:40 set ^P(i)=i'
source ./gtmenv B V6.3-000A_x86_64 
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^A(98)=99'
source ./gtmenv P V6.3-000A_x86_64
./replicating_stop 
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^A(99)=100'
./originating_stop
source ./gtmenv B V6.3-000A_x86_64
./originating_start B A 4010
./originating_start B P 4011
./backup_repl startB
$gtm_dist/mumps -r ^%XCMD 'set ^B(61)=0,^B(62)=1'
source ./gtmenv P V6.3-000A_x86_64
./rollback 4011 backward
./suppl_setup P startB 4011 -updok
$gtm_dist/mumps -r ^%XCMD 'for i=39:1:40 set ^P(i)=i'
source ./gtmenv A V6.3-000A_x86_64
./rollback 4010 backward
./replicating_start A 4010
source ./gtmenv B V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^B(64)=1,^B(65)=1'
cat A/gtm.lost
cat P/gtm.lost</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv B V6.3-000A_x86_64
./originating_stop
source ./gtmenv A V6.3-000A_x86_64 
./replicating_stop
source ./gtmenv P V6.3-000A_x86_64
./replicating_stop</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="rollbk_nt_req"></a>Rollback not required by application design</h4></div></div></div>
<p>The following scenario demonstrates a switchover from B&#8592;A&#8594;P to A&#8592;B&#8594;P when A and P have unreplicated updates. By application design, unreplicated updates on P do not require rollback when B becomes the new originating instance. </p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>A</strong></span></p>
            </th>
<th>
              <p><span class="italic">B</span></p>
            </th>
<th>
              <p><span class="underline">P</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="underline">P40</span></p>
            </td>
<td>
              <p><span class="bold"><strong>A</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">B</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A97</strong></span> and <span class="underline">P</span> as a SI that includes transaction number <span class="bold"><strong>A98</strong></span>, interspersed with locally generated updates. Updates are recorded in each instance's journal files using before-image journaling.</p>
            </td>
</tr>
<tr>
<td>
              <p>Crashes</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="underline">P40</span></p>
            </td>
<td>
              <p>When an event disables <span class="bold"><strong>A</strong></span>, <span class="italic">B</span> becomes the new originating primary, with <span class="bold"><strong>A97</strong></span> the latest transaction in its database and starts processing application logic. Unlike the previous example, in this case, application design permits (or requires) <span class="underline">P</span> to start replicating from <span class="italic">B</span> even though <span class="italic">B</span> does not have <span class="bold"><strong>A98</strong></span> in its database and <span class="underline">P</span> may have relied on <span class="bold"><strong>A98</strong></span> to compute <span class="underline">P39</span> and <span class="underline">P40</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="underline">P40</span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>With its Receiver Server started with the -noresync option, <span class="underline">P</span> can receive a SI replication stream from <span class="italic">B</span>, and replication starts from the last common transaction shared by <span class="italic">B</span> and <span class="underline">P</span>. Notice that on <span class="italic">B</span> no <span class="bold"><strong>A98</strong></span> precedes <span class="italic">B61</span>, whereas it does on <span class="underline">P</span>, i.e., <span class="underline">P</span> was ahead of <span class="italic">B</span> with respect to the updates generated by <span class="bold"><strong>A</strong></span>.</p>
            </td>
</tr>
</tbody>
</table></div>
<p>The following example creates this scenario.</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./db_create
./repl_setup
./originating_start A B 4010
./originating_start A P 4011
./backup_repl startA
$gtm_dist/mumps -r ^%XCMD 'for i=1:1:97 set ^A(i)=i'
source ./gtmenv B V6.3-000A_x86_64
./db_create
./repl_setup
./replicating_start B 4010 
source ./gtmenv P V6.3-000A_x86_64
./db_create
./suppl_setup P startA 4011 -updok
$gtm_dist/mumps -r ^%XCMD 'for i=1:1:40 set ^P(i)=i'
source ./gtmenv B V6.3-000A_x86_64 
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^A(98)=99'
source ./gtmenv P V6.3-000A_x86_64
./replicating_stop 
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^A(99)=100'
./originating_stop
source ./gtmenv B V6.3-000A_x86_64
./originating_start B A 4010
./originating_start B P 4011
#./backup_repl startB
$gtm_dist/mumps -r ^%XCMD 'set ^B(61)=0,^B(62)=1'
source ./gtmenv P V6.3-000A_x86_64
./replicating_start_suppl_n P 4011 -updok -noresync
$gtm_dist/mumps -r ^%XCMD 'for i=39:1:40 set ^P(i)=i'
source ./gtmenv A V6.3-000A_x86_64
./rollback 4010 backward
./replicating_start A 4010 
source ./gtmenv B V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^B(64)=1,^B(65)=1'</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv B V6.3-000A_x86_64
./originating_stop
source ./gtmenv A V6.3-000A_x86_64
./replicating_stop
source ./gtmenv P V6.3-000A_x86_64
./replicating_stop</pre>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="automatic_rollback1"></a>Rollback automatically</h4></div></div></div>
<div class="informaltable">
<p>This scenario demonstrates the use of the -autorollback qualifier which performs a ROLLBACK ONLINE FETCHRESYNC under the covers.  </p>
<table border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>A</strong></span></p>
            </th>
<th>
              <p><span class="italic">B</span></p>
            </th>
<th>
              <p><span class="underline">P</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P37</span>, <span class="underline">P38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span>, <span class="underline">P40</span></p>
            </td>
<td>
              <p><span class="bold"><strong>A</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">B</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A97</strong></span> and <span class="underline">P</span> as a SI that includes transaction number <span class="bold"><strong>A98</strong></span>, interspersed with locally generated updates. Updates are recorded in each instance"s journal files using before-image journaling.</p>
            </td>
</tr>
<tr>
<td>
              <p>R: Rolls back to <span class="bold"><strong>A97</strong></span> with <span class="bold"><strong>A98</strong></span> and <span class="bold"><strong>A99</strong></span> in the Unreplicated Transaction Log.</p>
            </td>
<td>
              <p>O: <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>S:Rolls back <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">P38</span>, and <span class="italicunderline">P40</span></p>
            </td>
<td>
              <p>Instances receiving a replication stream from <span class="bold"><strong>A</strong></span> can be configured to rollback automatically when <span class="bold"><strong>A</strong></span> performs an online rollback by starting the Receiver Server with -autorollback. If <span class="underline">P</span>"s Receiver Server is so configured, it will roll <span class="bold"><strong>A98</strong></span>, <span class="underline">P39</span> and <span class="underline">P40</span> into an Unreplicated Transaction Log. This scenario is straightforward. With the -noresync qualifier, the Receiver Server can be configured to simply resume replication without rolling back.</p>
            </td>
</tr>
</tbody>
</table>
</div>
<p>The following example run this scenario.</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./db_create
./repl_setup
./originating_start A P 4000
./originating_start A B 4001
source ./gtmenv B V6.3-000A_x86_64
./db_create
./repl_setup
./replicating_start B 4001
source ./gtmenv A V6.3-000A_x86_64
./backup_repl startA 
source ./gtmenv P V6.3-000A_x86_64
./db_create
./suppl_setup P startA 4000 -updok
$gtm_dist/mumps -r %XCMD 'for i=1:1:38 set ^P(i)=i'
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r %XCMD 'for i=1:1:97 set ^A(i)=i'
source ./gtmenv B V6.3-000A_x86_64
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r %XCMD 'set ^A(98)=50'
source ./gtmenv P V6.3-000A_x86_64
$gtm_dist/mumps -r %XCMD 'for i=39:1:40 set ^P(i)=i'
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r %XCMD 'set ^A(99)=100'
./originating_stop
source ./gtmenv B V6.3-000A_x86_64
./originating_start B A 4001 
./originating_start B P 4000
source ./gtmenv A V6.3-000A_x86_64
./replicating_start A 4001 -autorollback
source ./gtmenv P V6.3-000A_x86_64
#./rollback 4000 backward
./replicating_start_suppl_n P 4000 -updok -autorollback
#./replicating_start_suppl_n P 4000 -updok </pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./replicating_stop
source ./gtmenv P V6.3-000A_x86_64
./replicating_stop
source ./gtmenv B V6.3-000A_x86_64
./originating_stop</pre>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="recov_bapq"></a>Switchover possibilities in a B&#8592;A&#8594;P&#8594;Q replication configuration </h3></div></div></div>
<p>Consider a situation where A and P are located in one data center, with BC replication to B and Q respectively, located in another data center. When the first data center fails, the SI replication from A to P is replaced by SI replication from B to Q. The following scenario describes a switchover from B&#8592;A&#8594;P&#8594;Q to A&#8592;B&#8594;Q&#8594;P with unreplicated updates on A and P.</p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>A</strong></span></p>
            </th>
<th>
              <p><span class="italic">B</span></p>
            </th>
<th>
              <p><span class="underline">P</span></p>
            </th>
<th>
              <p><span class="italicunderline">Q</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">P37</span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">P38</span></p>
            </td>
<td>
              <p>R: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">P37</span></p>
            </td>
<td>
              <p><span class="bold"><strong>A</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">B</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A98</strong></span> and <span class="underline">P</span> as a SI that includes transaction number <span class="bold"><strong>A97</strong></span>, interspersed with locally generated updates. <span class="underline">P</span> in turn replicates to <span class="italicunderline">Q</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>Goes down with the data center</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>Goes down with the data center</p>
            </td>
<td>
              <p>... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">P37</span></p>
            </td>
<td>
              <p>When a data center outage disables <span class="bold"><strong>A</strong></span>, and <span class="underline">P</span>, <span class="italic">B</span> becomes the new originating primary, with <span class="bold"><strong>A98</strong></span> as the latest transaction in its database and starts processing application logic to maintain business continuity. <span class="italicunderline">Q</span> can receive the SI replication stream from <span class="italic">B</span>, without requiring a rollback since the receiver is not ahead of the source.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>-</p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">P37</span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">Q73</span>, <span class="italic">B61</span>, <span class="italicunderline">Q74</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p><span class="italicunderline">Q</span> receives SI replication from <span class="italic">B</span> and also applies its own locally generated updates. Although <span class="bold"><strong>A97</strong></span> and <span class="bold"><strong>A98</strong></span> were originally generated on <span class="bold"><strong>A</strong></span>, <span class="italicunderline">Q</span> receives them from <span class="italic">B</span>. <span class="italicunderline">Q</span> also computes and applies locally generated updates</p>
            </td>
</tr>
<tr>
<td>
              <p>... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">P37</span>, <span class="bold"><strong>A97</strong></span>,<span class="bold"><strong>A98</strong></span>, <span class="underline">P38</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">P37</span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">Q73</span>, <span class="italic">B61</span>, <span class="italicunderline">Q74</span>, <span class="italic">B62</span>, <span class="italicunderline">Q75</span>, <span class="italic">B63</span>, <span class="italicunderline">Q76</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>While <span class="italic">B</span> and <span class="italicunderline">Q</span>, keep the enterprise in operation, the first data center is recovered. Since <span class="bold"><strong>A</strong></span> has transactions in its database that were not replicated to <span class="italic">B</span> when the latter started operating as the originating primary instance, and since <span class="underline">P</span> had transactions that were not replicated to <span class="italicunderline">Q</span> when the latter took over, <span class="bold"><strong>A</strong></span> and <span class="underline">P</span> must now rollback their databases and create Unreplicated Transaction Files before receiving BC replication streams from <span class="italic">B</span> and <span class="italicunderline">Q</span> respectively. <span class="bold"><strong>A</strong></span> rolls off <span class="bold"><strong>A99</strong></span>, <span class="underline">P</span> rolls off <span class="underline">P38</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span>, B65</p>
            </td>
<td>
              <p>R: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">P37</span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">Q73</span>, <span class="italic">B61</span>, <span class="italicunderline">Q74</span>, <span class="italic">B62</span>, <span class="italicunderline">Q75</span>, <span class="italic">B63</span>, <span class="italicunderline">Q76</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">P34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">P35</span>, <span class="underline">P36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">P37</span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">Q73</span>, <span class="italic">B61</span>, <span class="italicunderline">Q74</span>, <span class="italic">B62</span>, <span class="italicunderline">Q75</span>, <span class="italic">B63</span>, <span class="italicunderline">Q76</span>, <span class="italic">B64</span>, <span class="italicunderline">Q77</span></p>
            </td>
<td>
<p>Having rolled off their transactions into Unreplicated Transaction Logs, <span class="bold"><strong>A</strong></span> can now operate as a BC replicating instance to <span class="italic">B</span> and <span class="underline">P</span> can operate as the SI replicating instance to <span class="italicunderline">Q</span>. <span class="italic">B</span> and <span class="underline">Q</span> continue operating as originating primary instance and supplementary instance. <span class="italicunderline">P</span> automatically receives M38 after applying the Unreplicated Transaction Log (from <span class="italicunderline">P</span>) to <span class="underline">Q</span>. <span class="italic">A</span> and <span class="italicunderline">P</span> automatically receive A99 after applying the Unreplicated Transaction Log (from <span class="italic">A</span>) to <span class="bold"><strong>B</strong></span>.</p>
            </td>
</tr>
</tbody>
</table></div>
<p>The following example runs this scenario.</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./db_create
./repl_setup
./originating_start A P 4000
./originating_start A B 4001
source ./gtmenv B V6.3-000A_x86_64
./db_create
./repl_setup
./replicating_start B 4001
source ./gtmenv A V6.3-000A_x86_64
./backup_repl startA 
source ./gtmenv P V6.3-000A_x86_64
./db_create
./suppl_setup P startA 4000 -updok
./backup_repl startP
./originating_start P Q 4005
source ./gtmenv Q V6.3-000A_x86_64
./db_create
./suppl_setup Q startP 4005 -updnotok
source ./gtmenv A V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'for i=1:1:96 set ^A(i)=i'
source ./gtmenv P V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'for i=1:1:37 set ^P(i)=i'
source ./gtmenv Q V6.3-000A_x86_64
./replicating_stop
source ./gtmenv P V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^P(38)=1000'
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64 
$gtm_dist/mumps -r ^%XCMD 'set ^A(97)=1000,^A(98)=1000'
source ./gtmenv B V6.3-000A_x86_64
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64 
$gtm_dist/mumps -r ^%XCMD 'set ^A(99)=1000'
./originating_stop 
source ./gtmenv B V6.3-000A_x86_64
backup_repl startB
./originating_start B Q 4008
$gtm_dist/mumps -r ^%XCMD 'for i=1:1:62 set ^B(i)=i'
source ./gtmenv Q V6.3-000A_x86_64
./rollback 4008 backward
./suppl_setup Q startB 4008 -updok
$gtm_dist/mumps -r ^%XCMD 'for i=1:1:74 set ^Q(i)=i'
source ./gtmenv B V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'for i=63:1:64 set ^B(i)=i'
./originating_start B A 4004
source ./gtmenv A V6.3-000A_x86_64
./rollback 4004 backward
./replicating_start A 4004
source ./gtmenv Q V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'for i=75:1:76 set ^Q(i)=i'
./originating_start Q P 4007
./backup_repl startQ
source ./gtmenv P V6.3-000A_x86_64
./rollback 4007 backward
./replicating_start_suppl_n P 4007 -updnotok
source ./gtmenv Q V6.3-000A_x86_64
$gtm_dist/mumps -r ^%XCMD 'set ^Q(77)=1000'
cat A/gtm.lost
cat P/gtm.lost</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv P V6.3-000A_x86_64
./replicating_stop
source ./gtmenv A V6.3-000A_x86_64
./replicating_stop
source ./gtmenv Q V6.3-000A_x86_64
./replicating_stop
./originating_stop
source ./gtmenv B V6.3-000A_x86_64
./originating_stop</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="gldreplupd"></a>Changing the global directory in an A&#8594;B replication configuration</h3></div></div></div>
<p>In a replication configuration, a global directory provides information to map global updates to their respective database files. As replication processes pick the state of the global directory at process startup, any change made to the global directory requires process restarts (at a minimum) to bring that change into effect. A switchover mechanism can ensure application availability while making global directory changes. </p>
<p>On B:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Shut down the Receiver Server and the Update Process. </p></li>
<li class="listitem"><p>Make a copy of the current global directory. </p></li>
<li class="listitem"><p>If the globals you are moving have triggers, make a copy of their definitions with MUPIP TRIGGER -SELECT and delete them with MUPIP TRIGGER.</p></li>
<li class="listitem"><p>Update the global directory.</p></li>
<li class="listitem"><p>If you are rearranging the global name spaces which do not contain any data, skip to step 9. </p></li>
<li class="listitem"><p>Create a backup copy of B, turn off replication, and cut the previous links of the journal file. </p></li>
<li class="listitem"><p>Use the MERGE command to copy a global from the prior to the new location. Use extended references (to the prior global directory) to refer to global in the prior location. </p></li>
<li class="listitem"><p>If the globals you are moving have triggers, apply the definitions saved in step 3.</p></li>
<li class="listitem"><p>Turn replication on for the region of the new global location. </p></li>
<li class="listitem"><p>Make B the new originating instance. For more information, refer to <a class="xref" href="ch07s03.html#nrml_cutov" title="Switchover possibilities in an A&#8594;B replication configuration">&#8220;Switchover possibilities in an A&#8594;B replication configuration&#8221;</a>.</p></li>
</ol></div>
<p>On A: </p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Shutdown replication.</p></li>
<li class="listitem"><p>If the globals you are moving have triggers, make a copy of their definitions with MUPIP TRIGGER -SELECT and delete them with MUPIP TRIGGER; note if the triggers are the same as those on B, which they normally would be for a BC instance you can just delete them and use the definitions saved on B.</p></li>
<li class="listitem"><p>Update the global directory.</p></li>
<li class="listitem"><p>If you are rearranging the global name spaces which do not contain any data, skip to step 7. </p></li>
<li class="listitem"><p>Create a backup copy of A, turn off replication, and cut the previous links of the journal file. </p></li>
<li class="listitem"><p>Use the MERGE command to copy a global from the prior to the new location. Use extended references (to the prior global directory) to refer to global in the prior location. </p></li>
<li class="listitem"><p>If the globals you are moving have triggers, apply the definitions saved in step 1.</p></li>
<li class="listitem"><p>Turn replication on for the region of the new global location. </p></li>
<li class="listitem"><p>Make A the new replicating instance. </p></li>
</ol></div>
<p>Perform a switchover to return to the A-&gt;B configuration. Once normal operation resumes, remove the global from the prior location (using extended references) to release space. </p>
<p>If a switchover mechanism is not in place and a downtime during the global directory update is acceptable, follow these steps:</p>
<p>On B:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Perform steps 1 to 9. </p></li>
<li class="listitem"><p>Restart the Receiver Server and the Update Process.</p></li>
</ul></div>
<p>On A:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Bring down the application (or prevent new updates from getting started). </p></li>
<li class="listitem"><p>Perform Steps 1 to 8. </p></li>
<li class="listitem"><p>Restart the originating instance.</p></li>
<li class="listitem"><p>Restart the active Source Server. </p></li>
<li class="listitem"><p>Bring up the application. </p></li>
</ul></div>
<p>This example adds the mapping for global ^A to a new database file A.dat in an A-&gt;B replication configuration. </p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64 
./db_create
./repl_setup
./originating_start A B 4001
source ./gtmenv B V6.3-000A_x86_64
./db_create
./repl_setup
./replicating_start B 4001
source ./gtmenv A V6.3-000A_x86_64 
$gtm_dist/mumps -r %XCMD 'for i=1:1:10 set ^A(i)=i'
./repl_status
source ./gtmenv B V6.3-000A_x86_64
./replicating_stop
cp B/gtm.gld B/prior.gld
$gtm_dist/mumps -r ^GDE @updgld
./db_create
mkdir backup_B
$gtm_dist/mupip backup "*" backup_B  -replinst=backup_B/gtm.repl
$gtm_dist/mupip set -journal=on,before_images,filename=B/gtm.mjl -noprevjnlfile -region "DEFAULT"
$gtm_dist/mumps -r %XCMD 'merge ^A=^|"B/prior.gld"|A'
$gtm_dist/mupip set -replication=on -region AREG
./originating_start B A 4001
source ./gtmenv A V6.3-000A_x86_64 
./originating_stop
./rollback 4001 backward
cat A/gtm.lost  #apply lost transaction file on A. 
./replicating_start A 4001
./replicating_stop 
cp A/gtm.gld A/prior.gld
$gtm_dist/mumps -r ^GDE @updgld
./db_create
mkdir backup_A
$gtm_dist/mupip backup "*" backup_A -replinst=backup_A/gtm.repl
$gtm_dist/mupip set -journal=on,before_images,filename=A/gtm.mjl -noprevjnlfile -region "DEFAULT"
$gtm_dist/mumps -r %XCMD 'merge ^A=^|"A/prior.gld"|A'
$gtm_dist/mupip set -replication=on -region AREG
./replicating_start A 4001
./repl_status
#Perform a switchover to return to the A-&gt;B configuration. Remove the global in the prior location to release space with a command like Kill ^A=^|"A/prior.gld"|A'. </pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./gtmenv A V6.3-000A_x86_64
./replicating_stop
source ./gtmenv B V6.3-000A_x86_64
./originating_stop</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="roll_sft_upg"></a>Rolling Software Upgrade</h3></div></div></div>
<p>A rolling software upgrade is the procedure of upgrading an instance in a way that there is minimal impact on the application uptime. An upgrade may consist of changing the underlying database schema, region(s), global directory, database version, application version, triggers, and so on. There are two approaches for a rolling upgrade. The first approach is to upgrade the replicating instance and then upgrade the originating instance. The second approach is to upgrade the originating instance  first while its replicating (standby) instance acts as an originating instance. </p>
<p>The following two procedures demonstrate these rolling software upgrade approaches for upgrading an A&#8594;B replication configuration running an application using GT.M V6.1-000_x86_64 to GT.M V6.2-001_x86_64 with minimal (a few seconds) impact on the application downtime. </p>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="upg_repl_first"></a>Upgrade the replicating instance first (A&#8594;B)</h4></div></div></div>
<p>On B:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Shut down the passive Source and Receiver Servers and the application. </p></li>
<li class="listitem"><p>Turn off replication. </p></li>
<li class="listitem"><p>Perform a MUPIP RUNDOWN operation and make a backup.</p></li>
<li class="listitem"><p>Open DSE, run DUMP -FILEHEADER for each region (FIND -REGION=&lt;Region_Name&gt;) and note down the largest Region Seqno. </p></li>
<li class="listitem"><p>Upgrade the instance. An upgrade may include include adding triggers, adding/removing regions, changing GDE mapping, and so on. </p></li>
<li class="listitem"><p>Open DSE again, run DSE DUMP -FILEHEADER for each region (FIND -REGION=&lt;Region_Name&gt;) and note down the largest Region Seqno. If the largest Region Seqno noted in step 4 and largest Region Seqno noted in this step are the same, proceed to step 7. Otherwise, execute DSE CHANGE -FILEHEADER -
REG_SEQNO=&lt;Largest_Region_Seqno_from_step_4&gt; for the region having the largest Region Seqno. </p></li>
<li class="listitem">
<p>Cut the back links to the prior generation journal files with a command like: </p>
<pre class="programlisting">$gtm_dist/mupip set -journal=on,before_images,filename=B/gtm.mjl -noprevjnlfile -region "DEFAULT"</pre>
</li>
<li class="listitem"><p>Turn on replication. </p></li>
<li class="listitem"><p>If the use of replication filters apply to your situation, bring up the replicating instance with the new-to-old filter on the Source Server of A, and the old-to-new filter on the Receiver Server of B. Otherwise, bring up the replicating instance on B. </p></li>
<li class="listitem"><p>Wait for B to automatically catup up the pending updates from A. </p></li>
</ol></div>
<p>on A:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>When there are no/low updates on A, shut down the Source Server. </p></li>
<li class="listitem"><p>Turn off replication. </p></li>
<li class="listitem"><p>Perform a MUPIP RUNDOWN and make a backup copy of the database.</p></li>
<li class="listitem"><p>Perform a switchover to make B the originating instance. Apply lost/broken transactions, if any, on B. </p></li>
<li class="listitem"><p>Open DSE, run DUMP -FILEHEADER for each region (FIND -REGION=&lt;Region_Name&gt;) and note down the largest Region Seqno. </p></li>
<li class="listitem"><p>Upgrade the instance. An upgrade may include include adding triggers, adding/removing regions, changing GDE mapping, and so on. </p></li>
<li class="listitem"><p>Open DSE again, run DSE DUMP -FILEHEADER for each region (FIND -REGION=&lt;Region_Name&gt;) and note down the largest Region Seqno. If the largest Region Seqno noted in step 5 and largest Region Seqno noted in this step are the same, proceed to step 8. Otherwise, execute DSE CHANGE -FILEHEADER -REG_SEQNO=&lt;Largest_Region_Seqno_from_step_5&gt; for the region having the largest Region Seqno. </p></li>
<li class="listitem">
<p>Cut the back links to the prior generation journal files with a command like: </p>
<pre class="programlisting">$gtm_dist/mupip set -journal=on,before_images,filename=A/gtm.mjl -noprevjnlfile -region DEFAULT</pre>
</li>
<li class="listitem"><p>Turn on replication. </p></li>
<li class="listitem"><p>Start the Receiver Server of A. </p></li>
</ol></div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="upd_orig_first"></a>Upgrade the originating instance first (A&#8594;B)</h4></div></div></div>
<p>on A:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>When there are no updates on A and both A and B are in sync, shut down the Source Server.</p></li>
<li class="listitem"><p>Turn off replication. </p></li>
<li class="listitem"><p>Perform a MUPIP RUNDOWN and make a backup copy of the database.</p></li>
<li class="listitem"><p>Perform a switchover to make B the originating instance. This ensure application availability during the upgrade of A. </p></li>
<li class="listitem"><p>Open DSE, run DUMP -FILEHEADER for each region (FIND -REGION=&lt;Region_Name&gt;) and note down the largest Region Seqno. </p></li>
<li class="listitem"><p>Upgrade the instance. An upgrade may include include adding triggers, adding/removing regions, changing GDE mapping, upgrading the GT.M version, and so on. </p></li>
<li class="listitem"><p>Open DSE again, run DSE DUMP -FILEHEADER for each region (FIND -REGION=&lt;Region_Name&gt;) and note down the largest Region Seqno. If the largest Region Seqno noted in step 5 and largest Region Seqno noted in this step are the same, proceed to step 8. Otherwise, execute DSE CHANGE -FILEHEADER -REG_SEQNO=&lt;Largest_Region_Seqno_from_step_5&gt; for the region having the largest Region Seqno. </p></li>
<li class="listitem">
<p>Cut the back links to the prior generation journal files with a command like: </p>
<pre class="programlisting">$gtm_dist/mupip set -journal=on,before_images,filename=A/gtm.mjl -noprevjnlfile -region DEFAULT</pre>
</li>
<li class="listitem"><p>Turn on replication. </p></li>
<li class="listitem"><p>If the use of replication filters apply to your situation, bring up the Receiver Server with the old-to-new filter. Otherwise bring up the Receiver Server. </p></li>
<li class="listitem"><p>Wait for A to automatically catch up the pending updates from B.  </p></li>
</ol></div>
<p>on B:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>When there are no/low updates on A, shut down the Source Server. </p></li>
<li class="listitem"><p>Turn off replication. </p></li>
<li class="listitem"><p>Perform a MUPIP RUNDOWN and make a backup copy of the database. </p></li>
<li class="listitem"><p>Perform a switchover to reinstate A as the originating instance. This ensures application availability during the upgrade of B. </p></li>
<li class="listitem"><p>Open DSE, run DUMP -FILEHEADER for each region (FIND -REGION=&lt;Region_Name&gt;) and note down the largest Region Seqno.</p></li>
<li class="listitem"><p>Upgrade the instance. An upgrade may include include adding triggers, adding/removing regions, changing GDE mapping, and so on. </p></li>
<li class="listitem"><p>Open DSE again, run DSE DUMP -FILEHEADER for each region (FIND -REGION=&lt;Region_Name&gt;) and note down the largest Region Seqno. If the largest Region Seqno noted in step 5 and largest Region Seqno noted in this step are the same, proceed to step 8. Otherwise, execute DSE CHANGE -FILEHEADER -REG_SEQNO=&lt;Largest_Region_Seqno_from_step_5&gt; for the region having the largest Region Seqno. </p></li>
<li class="listitem">
<p>Cut the back links to the prior generation journal files with a command like: </p>
<pre class="programlisting">$gtm_dist/mupip set -journal=on,before_images,filename=B/gtm.mjl -noprevjnlfile -region DEFAULT</pre>
</li>
<li class="listitem"><p>Turn on replication. </p></li>
<li class="listitem"><p>Start the Receiver Server of B. </p></li>
<li class="listitem"><p>The upgrade of A and B is complete. </p></li>
</ol></div>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Note on Triggers">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Important]" src="images/important.jpg"></td>
<th align="left">Note on Triggers</th>
</tr>
<tr><td align="left" valign="top"><p>While adding triggers, bear in mind that triggers get replicated if you add them when replication is turned on. However, when you add triggers when replication is turned off, those triggers and the database updates resulting from the executing their trigger code do not get replicated.</p></td></tr>
</table></div>
<p>Here is an example to upgrade A and B deployed in an A&#8594;B replication configuration from V6.1-000_x86_64 to V6.2-001_x86_84. This example uses instructions from the <a class="xref" href="ch07s03.html#upd_orig_first" title="Upgrade the originating instance first (A&#8594;B)">&#8220;Upgrade the originating instance first (A&#8594;B)&#8221;</a> procedure. </p>
<pre class="programlisting">source ./env A V6.1-000_x86_64
./db_create
./repl_setup
./originating_start A B 4001
source ./env B V6.1-000_x86_64
./db_create
./repl_setup
./replicating_start B 4001
source ./env A V6.1-000_x86_64
$gtm_dist/mumps -r %XCMD 'for i=1:1:100 set ^A(i)=i'
./status
source ./env B V6.1-000_x86_64
./replicating_stop
source ./env A V6.1-000_x86_64
./status
./originating_stop 
$gtm_dist/mupip set -replication=off -region "DEFAULT"
$gtm_dist/dse dump -f 2&gt;&amp;1| grep "Region Seqno"
#Perform a switchover to make B the originating instance. 
source ./env A V6.2-001_x86_64
$gtm_dist/mumps -r ^GDE exit
$gtm_dist/mupip set -journal=on,before_images,filename=A/gtm.mjl -noprevjnlfile -region "DEFAULT"
#Perform the upgrade 
$gtm_dist/dse dump -fileheader 2&gt;&amp;1| grep "Region Seqno"
#If Region Seqno is greater than the Region Seqno noted previously, run $gtm_dist/dse change -fileheader -req_seqno=&lt;previously_noted_region_seqno&gt;.
./repl_setup
#A is now upgraded to V6.2-001_x86_64 and is ready to resume the role of the originating instance. Shutdown B and reinstate A as the originating instance. 
./originating_start A B 4001
source ./env B V6.2-001_x86_64
$gtm_dist/mumps -r ^GDE exit
$gtm_dist/mupip set -journal=on,before_images,filename=B/gtm.mjl -noprevjnlfile -region "DEFAULT"
#Perform the upgrade 
$gtm_dist/dse dump -fileheader 2&gt;&amp;1| grep "Region Seqno"
#If Region Seqno is different, run $gtm_dist/dse change -fileheader -req_seqno=&lt;previously_noted_region_seqno&gt;.
$gtm_dist/dse dump -f 2&gt;&amp;1| grep "Region Seqno"
#If Region Seqno is greater than the Region Seqno noted previously, run $gtm_dist/dse change -fileheader -req_seqno=&lt;previously_noted_region_seqno&gt;.
./repl_setup
./replicating_start B 4001</pre>
<p>The shutdown sequence is as follows:</p>
<pre class="programlisting">source ./env B V6.2-001_x86_64
./replicating_stop
source ./env A V6.2-001_x86_64
./originating_stop</pre>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="shut_inst"></a>Shutting down an instance</h3></div></div></div>
<p>To shutdown an originating instance:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Shut down all GT.M and mupip processes that might be attached to the Journal Pool.</p></li>
<li class="listitem"><p>In case the originating instance is also a supplementary instance, shutdown the Receiver Server(s) (there might be more than one Receiver Server in future GT.M versions).</p></li>
<li class="listitem"><p>Shut down all active and/or passive Source Servers.</p></li>
<li class="listitem"><p>Execute mupip rundown -region to ensure that the database, Journal Pool, and Receiver Pool shared memory is rundown properly.</p></li>
</ul></div>
<p>To shutdown a propagating instance:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Shut down all replicating instance servers (Receiver Server, Update Process and its Helper processes).</p></li>
<li class="listitem"><p>Shutdown the originating instance servers (all active and/or passive Source Servers).</p></li>
<li class="listitem"><p>On its replicating instances, ensure that there are no GT.M or MUPIP processes attached to the Journal Pool as updates are disabled (they are enabled only on the originating instance).</p></li>
<li class="listitem"><p>Execute mupip rundown -region to ensure that the database, Journal Pool, and Receiver Pool shared memory is rundown properly.</p></li>
</ul></div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="up_re_in_fi"></a>Creating a new Replication Instance File</h3></div></div></div>
<p>You do not need to create a new replication instance file except when you upgrade from a GT.M version prior to V5.5-000. Unless stated in the release notes of your GT.M version, you instance file does not need to be upgraded. If you are creating a new replication instance file for any administration purpose, remember that doing do so will remove history records which may prevent it from resuming replication with other instances. To create a new replication instance file, follow these steps:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Shut down all mumps, MUPIP and DSE processes except Source and Receiver Server processes; then shut down the Receiver Server (and with it, the Update Process) and all Source Server processes. Use MUPIP RUNDOWN to confirm that all database files of the instance are closed and there are no processes accessing them.</p></li>
<li class="listitem">
<p>Create a new replication instance file (you need to provide the instance name and instance file name, either with command line options or in environment variables, as described in other examples of this section):</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle">
<li class="listitem">
<p>If this is instance is to receive SI replication or to receive BC replication from an instance that receives SI replication, use the command:</p>
<pre class="programlisting"> mupip replicate -instance_create -supplementary</pre>
</li>
<li class="listitem">
<p>Otherwise use the command:</p>
<pre class="programlisting">mupip replicate -instance_create</pre>
</li>
<li class="listitem"><p>If a replication instance file already exists, these commands will create a backup copy of the replicating instance and then create a new replication instance file. If you want to prevent accidental overwriting your existing replication instance file, use the -noreplace qualifier with these commands. </p></li>
</ul></div>
</li>
<li class="listitem">
<p>Prepare it to accept a replication stream:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="circle">
<li class="listitem"><p>Start a passive Source Server. If this is an SI replicating instance, use the -updok flag to start the passive Source Server.</p></li>
<li class="listitem"><p>Start the Receiver Server using the updateresync. For versions prior to V5.5-000 use the -updateresync qualifier and for GT.M versions V5.5-000 or newer use -updateresync=&lt;repl_inst&gt;.For example, mupip replicate -receiver -start -updateresync=&lt;repl_inst&gt; where repl_inst is the prior replication file if the source is V5.5-000 or newer and -updateresync if it is an older GT.M release.</p></li>
</ul></div>
</li>
<li class="listitem"><p>Start a Source Server on a root or propagating primary instance to replicate to this instance. Verify that updates on the source instance are successfully replicated to the receiver instance.</p></li>
</ul></div>
<p>The -updateresync qualifier indicates that instead of negotiating a mutually agreed common starting point for synchronization the operator is guaranteeing the receiving instance has a valid state that matches the source instance currently or as some point in the past. Generally this means the receiving instance has just been updated with a backup copy from the source instance.</p>
<p>On instances with the same endian-ness, follow these steps to create a replication instance file without using the -updateresync qualifier. </p>
<p>On the source side:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Use the MUPIP BACKUP command with the -REPLINSTANCE qualifier to backup the instance to be copied.  The source server for the instance must be started at least once before backing up the replication instance file.</p></li>
<li class="listitem"><p>Ship the backed up databases and instance file to the receiving side.</p></li>
</ul></div>
<p>On the receiving side:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Run the MUPIP REPLIC -EDITINST command on the backed up instance file to change the instance name to reflect the target instance. This makes the source replication instance file usable on the target instance while preserving the history records in the instance file.</p></li>
<li class="listitem"><p>Create new journal files, start a passive Source Server and a Receiver Server (without an -updateresync qualifier).</p></li>
<li class="listitem"><p>Allow a Source Server to connect.</p></li>
</ul></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Note]" src="images/note.html"></td>
<th align="left"></th>
</tr>
<tr><td align="left" valign="top"><p>When the instances have different endian-ness, create a new replication instance file as described in <a class="xref" href="replication.html#create_repl_inst" title="Creating the Replication Instance File">&#8220;<span>Creating the Replication Instance File</span>&#8221;</a></p></td></tr>
</table></div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="tls_repl_proc"></a>Setting up a secured TLS replication connection</h3></div></div></div>
<p>The following example creates two instances (Alice and Bob) and a basic framework required for setting up a TLS replication connection between them. Alice and Bob are fictional characters from <a class="ulink" href="https://en.wikipedia.org/wiki/Alice_and_Bob" target="_top">https://en.wikipedia.org/wiki/Alice_and_Bob</a> and represent two instances who use the certificates signed by the same root CA. This example is solely for the purpose of explaining the general steps required to encrypt replication data in motion. You must understand, and appropriately adjust, the scripts before using them in a production environment. Note that all certificates created in this example are for the sake of explaining their roles in a TLS replication environment. For practical applications, use certificates signed by a CA whose authority matches your use of TLS.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Important">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Note]" src="images/note.html"></td>
<th align="left">Important</th>
</tr>
<tr><td align="left" valign="top"><p>Use the openssl.conf provided with repl_procedures.tar.gz to create the self-signed root certification authority (ca.crt) and leaf-level certificates used in this example. In production, ensure that you configure openssl.cnf according to your environment and security requirements. For example, in production you would keep root-level certificates in directories with 0500 permissions and the individual files with 0400 permissions so that unauthorized users cannot access them.</p></td></tr>
</table></div>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
<p>Remove the comment tags from the following lines in the gtmenv script:</p>
<pre class="programlisting">export LD_LIBRARY_PATH=/usr/local/lib
export gtmcrypt_config=$PWD/$gtm_repl_instname/config_file
echo -n "Enter Password for gtmtls_passwd_${gtm_repl_instname}: ";export gtmtls_passwd_${gtm_repl_instname}="`$gtm_dist/plugin/gtmcrypt/maskpass|tail -n 1|cut -f 3 -d " "`"</pre>
</li>
<li class="listitem">
<p>Execute the gtmenv script as follows:</p>
<pre class="programlisting">$ source ./gtmenv Alice V6.2-001_x86_64</pre>
<p>This creates a GT.M environment for replication instance name Alice. When prompted, enter a password for gtmtls_passwd_Alice. </p>
</li>
<li class="listitem">
<p>Create a certificate directory setup in the current directory and a self-signed root certification authority. </p>
<pre class="programlisting">$ ./cert_setup</pre>
<p>This creates a self-signed root certification authority (ca.crt) in $PWD/certs/. ca.crt needs to be available on both Source and Receiver Servers. In a production environment, ensure that you keep root-level certificates in directories with 0500 permissions and the individual files with 0400 permissions so that unauthorized users cannot access them. </p>
<p>The output of this script is like the following"</p>
<pre class="programlisting">Generating RSA private key, 512 bit long modulus
...........++++++++++++
...............++++++++++++
e is 65537 (0x10001)
Enter pass phrase for /home/jdoe/certs/ca.key:
Verifying - Enter pass phrase for /home/jdoe/certs/ca.key:
Enter pass phrase for /home/jdoe/certs/ca.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
Country Name (2 letter code) [US]:US
State or Province Name (full name) [Bobadelphia]:Bobadelphia
City (e.g., Malvern) [Malvern]:Malvern
Organization Name (eg, company) [FIS]:FIS
Organizational Unit Name (eg, section) [GT.M]:GT.M
Common Name (e.g. server FQDN or YOUR name) [localhost]:fis-gtm.com
Email Address (e.g. Alice@gt.m) []:root@gt.m</pre>
</li>
<li class="listitem">
<pre class="programlisting">./db_create</pre>
<p>This creates the global directory and the database for instance Alice. </p>
<pre class="programlisting">./gen_leaf</pre>
<p> This creates a leaf-level certificate for Alice. The openssl.conf used to create this example in available in the download for your reference. Ensure that your openssl.cnf file is configured according to your environment and security requirements.</p>
<p>The output of this script is like the following:</p>
<pre class="programlisting">Generating RSA private key, 512 bit long modulus
.++++++++++++
.......++++++++++++
e is 65537 (0x10001)
Enter pass phrase for /home/jdoe/certs/Alice.key: [Specify the password that you entered for gtmtls_passwd_Alice]
Verifying - Enter pass phrase for /home/jdoe/certs/Alice.key:
Enter pass phrase for /home/jdoe/certs/Alice.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
Country Name (2 letter code) [US]:
State or Province Name (full name) [Bobadelphia]:Illinois
City (e.g., Malvern) [Malvern]:Chicago
Organization Name (eg, company) [FIS]:FIS
Organizational Unit Name (eg, section) [GT.M]:GT.M
Common Name (e.g. server FQDN or YOUR name) [localhost]:fisglobal.com
Ename Address (e.g. Alice@gt.m) []:Alice@gt.m
Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
Using configuration from /usr/lib/ssl/openssl.cnf
Enter pass phrase for ./certs/ca.key:
Check that the request matches the signature
Signature ok
Certificate Details:
 Serial Number: 14 (0xe)
 Validity
 Not Before: Jun 11 14:06:53 2014 GMT
 Not After : Jun 12 14:06:53 2014 GMT
 Subject:
 countryName = US
 stateOrProvinceName = Illinois
 organizationName = FIS
 organizationalUnitName = GT.M
 commonName = fisglobal.com
 emailAddress = Alice@gt.m
 X509v3 extensions:
 X509v3 Basic Constraints:
 CA:FALSE
 Netscape Comment:
 OpenSSL Generated Certificate
 X509v3 Subject Key Identifier:
 96:FD:43:0D:0A:C1:AA:6A:BB:F3:F4:02:D6:1F:0A:49:48:F4:68:52
 X509v3 Authority Key Identifier:
 keyid:DA:78:3F:28:8F:BC:51:78:0C:5F:27:30:6C:C5:FE:B3:65:65:85:C9
Certificate is to be certified until Jun 12 14:06:53 2014 GMT (1 days)
Sign the certificate? [y/n]:y
1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated</pre>
</li>
<li class="listitem">
<p>Create the $gtmcrypt_config file. Specify the names of all participating instances. </p>
<pre class="programlisting">./gen_gc Alice Bob</pre>
</li>
<li class="listitem">
<p>Turn replication on and create the replication instance file: </p>
<pre class="programlisting">$ ./repl_setup</pre>
</li>
<li class="listitem">
<p>Start the originating instance Alice:</p>
<pre class="programlisting">$ ./originating_start Alice Bob 4001 -tlsid=Alice -reneg=2</pre>
</li>
</ol></div>
<p>On instance Bob:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
<p>Execute the gtmenv script as follows:</p>
<pre class="programlisting">$ source ./gtmenv Bob V6.2-001_x86_64</pre>
<p>This creates a GT.M environment for replication instance name Bob. When prompted, enter a password for gtmtls_passwd_Bob. </p>
</li>
<li class="listitem">
<pre class="programlisting">$ ./db_create</pre>
<p>This creates the global directory and the database for instance Bob. </p>
<pre class="programlisting">$ ./gen_leaf</pre>
<p> This also creates a leaf-level certificate for Bob. </p>
</li>
<li class="listitem">
<p>Create the $gtmcrypt_config file. Specify the names of all participating instances. </p>
<pre class="programlisting">./gen_gc Alice Bob</pre>
<p>Ensure that ca.key generated on Instance Alice is available on instance Bob. </p>
</li>
<li class="listitem">
<p>Turn replication on and create the replication instance file:</p>
<pre class="programlisting">$ ./repl_setup</pre>
</li>
<li class="listitem">
<p>Start the replicating instance Bob.</p>
<pre class="programlisting">$ ./replicating_start Bob 4001 -tlsid=Bob</pre>
</li>
</ol></div>
<p>For subsequent environment setup, use the following commands:</p>
<pre class="programlisting">source ./gtmenv Bob V6.2-001_x86_64 or source ./gtmenv Alice V6.2-001_x86_64
./replicating_start Bob 4001 -tlsid=Bob or ./originating_start Alice Bob 4001 -tlsid=Alice -reneg=2</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="schema_chng_filters"></a>Schema Change Filters<a class="indexterm" name="idp184590176"></a>
</h3></div></div></div>
<p>Filters between the originating and replicating systems perform rolling upgrades that involve database schema changes. The filters manipulate the data under the different schemas when the software revision levels on the systems differ.</p>
<p>GT.M provides the ability to invoke a filter; however, an application developer must write the filters specifically as part of each application release upgrade when schema changes are involved. </p>
<p>Filters should reside on the upgraded system and use logical database updates to update the schema before applying those updates to the database. The filters must invoke the replication Source Server (new schema to old) or the database replication Receiver Server (old schema to new), depending on the system's status as either originatig or replicating. For more information on Filters, refer to <a class="xref" href="ch07s01.html#Filters" title="Filters">&#8220;Filters&#8221;</a>. </p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="recwason"></a>Recovering from the replication WAS_ON state </h3></div></div></div>
<p>If you notice the replication WAS_ON state, correct the cause that made GT.M turn journaling off and then execute MUPIP SET -REPLICATION=ON.</p>
<p>To make storage space available, first consider moving unwanted non-journaled and temporary data. Then consider moving the journal files that predate the last backup. Moving the currently linked journal files is a very last resort because it disrupts the back links and a rollback or recover will not be able to get back past this discontinuity unless you are able to return them to their original location.</p>
<p>If the replication WAS_ON state occurs on the originating side:</p>
<p>If the Source Server does not reference any missing journal files, -REPLICATION=ON resumes replication with no downtime.</p>
<p>If the Source Server requires any missing journal file, it produces a REPLBRKNTRANS or NOPREVLINK error and shuts down. Note that you cannot rollback after journaling turned off because there is insufficient information to do such a rollback.</p>
<p>In this case, proceed as follows:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Take a backup (with MUPIP BACKUP -BKUPDBJNL=OFF -REPLINST=&lt;bckup_inst&gt;) of the originating instance.</p></li>
<li class="listitem"><p>Because journaling was turned off in the replication WAS_ON state, the originating instance cannot be rolled back to a state prior to the start of the backup. Therefore, cut the previous generation link of the journal files on the originating instance and turn replication back on. Both these operations can be accomplished with  MUPIP SET -REPLICATION="ON".
</p></li>
<li class="listitem"><p>Restore the replicating instance from the backup of the originating instance. Change the instance name of &lt;bckup_inst&gt; to the name of the replicating instance (with MUPIP REPLIC -EDITINST -NAME).</p></li>
<li class="listitem"><p>Turn on replication and journaling in the restored replicating instance. Specify the journal file pathname explicitly with MUPIP SET -JOURNAL=filename=&lt;repinst_jnl_location&gt; (as the backup database has the originating instance's journal file pathname).</p></li>
<li class="listitem"><p>Restart the Source Server process on the originating instance.</p></li>
<li class="listitem"><p>Start the Receiver Server (with no -UPDATERESYNC) the replicating instance.</p></li>
</ol></div>
<p>If the replication WAS_ON state occurs on the receiving side:</p>
<p>Execute MUPIP SET -REPLICATION=ON to return to the replication ON state. This resumes normal replication on the receiver side. As an additional safety check, extract the journal records of updates that occurred during the replication WAS_ON state on the originating instance and randomly check whether those updates are present in the receiving instance.</p>
<p>If replication does not resume properly (due to errors in the Receiver Server or Update Process), proceed as follows:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Take a backup (with MUPIP BACKUP -BKUPDBJNL=OFF -REPLINST=&lt;bckup_inst&gt;) of the originating instance.</p></li>
<li class="listitem"><p>Restore the replicating instance from the backup of the originating instance. Change the instance name of &lt;bckup_inst&gt; to the name of the replicating instance (with MUPIP REPLIC -EDITINST -NAME).</p></li>
<li class="listitem"><p>Turn on replication and journaling in the restored replicating instance. Specify the journal file pathname explicitly with MUPIP SET -JOURNAL=filename=&lt;repinst_jnl_location&gt; (as the backup database has the originating instance's journal file pathname).</p></li>
<li class="listitem"><p>Restart the Source Server process on the originating instance. Normally, the Source Server might still be running on the originating side.</p></li>
<li class="listitem"><p>Start the Receiver Server (with no -UPDATERESYNC) the replicating instance.</p></li>
</ol></div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="rollbidle"></a>Rollback data from crashed (idle) regions</h3></div></div></div>
<p>When a rollback operations fails with CHNGTPRSLVTM, NOPREVLINK, and JNLFILEOPENERR messages, evaluate whether you have a crashed region in your global directory that is seldom used for making updates (idle). The updates in an idle region's current generation journal file may have timestamps and sequence numbers that no longer exist in the prior generation journal file chains of more frequently updated regions because of periodic pruning of existing journal files as part of routine maintenance. MUPIP SET and BACKUP commands can also remove previous generation journal file links.</p>
<p>Terminating a process accessing an idle region abnormally (say with kill -9 or some other catastrophic event) may leave its journal files improperly closed. In such an case, the discrepancy may go unnoticed until the next database update or rollback. Performing a rollback including such an idle region may then resolve the unified rollback starting time, (reported with a CHNGTPRSLVTM message), to a point in time that does not exist in the journal file chain for the other regions, thus causing the rollback to fail.</p>
<p>In this rare but possible condition, first perform a rollback selectively for the idle region(s). Here are the steps:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Create a temporary global directory which maps only the idle region(s) by mapping one, often the only, such idle region's file to the default region.</p></li>
<li class="listitem"><p>Set the environment variable gtmgbldir to point to the temporary global directory.</p></li>
<li class="listitem"><p>Perform an optimal rollback (MUPIP JOURNAL -ROLLBACK -BACKWARD "*") </p></li>
<li class="listitem"><p>Analyze and process any broken or lost transaction files that the rollback procedure may generate. </p></li>
<li class="listitem"><p>Set the environment variable gtmgbldir to point back to the location of the global directory for your application. </p></li>
<li class="listitem"><p>Perform a normal rollback for your application. </p></li>
</ol></div>
<p>You do not need to perform these steps if you have a non-replicated but journaled database because RECOVER operations do not coordinate across regions.</p>
<p>As a general practice, perform an optimal recovery/rollback every time when starting a GT.M application from quiescence and, depending on the circumstances, after a GT.M process terminates abnormally.</p>
<p>FIS recommends rotating journal files with MUPIP SET when removing old journal files or ensuring that all regions are periodically updated.</p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="updateresyncproc1"></a>Setting up a new replicating instance of an originating instance (A&#8594;B,
P&#8594;Q, or A&#8594;P)</h3></div></div></div>
<p>To set up a new replicating instance of an originating instance for the first time or to replace a replicating instance if database and instance file get deleted, you need to create the replicating instance from a backup of the originating instance, or one of its replicating instances. </p>
<p>If you are running GT.M V5.5-000 or higher:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Take a backup of the database and the replication instance file of the originating instance together at the same time with BACKUP 
-REPLINSTANCE and transfer them to the location of the replicating instance. If the originator's replicating instance file was newly
created, take its backup while the Source Server is running to ensure that the backup contains at least one history record. </p></li>
<li class="listitem"><p>Use MUPIP REPLICATE -EDITINST -NAME=&lt;secondary-instname&gt; to change the replicating instance's name. </p></li>
<li class="listitem"><p>Start the replicating instance without -udpateresync. </p></li>
</ul></div>
<p>If you are running GT.M pre-V5.5-000:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Create a new replication instance file on the replicating instance.</p></li>
<li class="listitem"><p>Start the replicating instance with this new replication instance file with the -updateresync qualifier (no value specified).</p></li>
</ul></div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="updateresyncproc2"></a>Replacing the replication instance file of a replicating instance (A&#8594;B
and P&#8594;Q)</h3></div></div></div>
<p>In this case, it is possible that the replicating instance's database files are older than the originating instance. Note that to resume replication there is no need to transfer the backup of the originating instance's database and replication instance files. </p>
<p>To replace the existing replicating instance file with a new replication instance file, follow these steps: </p>
<p>If you are running GT.M V5.5-000 or higher:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Take a backup of just the replication instance file (no database files with 
BACKUP -REPLINST=&lt;/path/to/bkup-orig-repl-inst-file&gt;)
and transfer it to the site of the replicating instance.</p></li>
<li class="listitem"><p>Start the replicating instance with -updateresync=&lt;/path/to/bkup-orig-repl-inst-file&gt;.
</p></li>
</ul></div>
<p>In this case, the Receiver Server determines the current instance's journal sequence number by taking a maximum of the Region Sequence Numbers in the database file headers on the replicating instance and uses use the input instance file to locate the history record corresponding to this journal sequence number, and exchanges this
history information with the Source Server.</p>
<p>If you are running GT.M pre-V5.5-000:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Create a new replication instance file on the replicating instance. </p></li>
<li class="listitem"><p>Start the replicating instance with this new instance file with the -updateresync qualifier (no value specified).</p></li>
</ul></div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="updateresyncproc3"></a>Replacing the replication instance file of a replicating instance (A&#8594;P)</h3></div></div></div>
<p>On P:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Use the -SUPPLEMENTARY qualifier with the MUPIP REPLICATE -INSTANCE_CREATE command to indicate this is a supplementary instance file.</p></li>
<li class="listitem"><p>Start a Source Server on P with -UPDOK to indicate local updates are enabled on P.</p></li>
<li class="listitem"><p>Start the Receiver Server on P with the -UPDATERESYNC=&lt;/path/to/bkup-orig-repl-inst-file&gt;
qualifier and -RESUME. -RESUME indicates that A and P had been replicating before. The Receiver Server looks at the local (stream #0) sequence numbers in the database file headers on P and takes the maximum value to determine the journal sequence number of the new stream on P. It then uses this as the instance journal sequence number on A to resume  replication.</p></li>
</ul></div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="updateresyncproc4"></a>Setting up a new replicating instance from a backup of the originating instance
(A&#8594;P)</h3></div></div></div>
<p>On A:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Take a backup of the replication instance file and the database together at the same time with BACKUP -REPLINSTANCE and transfer it to P. If the A's replication instance file was also freshly created, then take the backup while the Source Server is running on the originating instance. This ensures that the backed up replication instance file
contains at least one history record.</p></li></ul></div>
<p>On P:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Create a new replication instance file. Use the -SUPPLEMENTARY qualifier with the MUPIP REPLICATE -INSTANCE_CREATE command to indicate this is a supplementary instance file.</p></li>
<li class="listitem"><p>Restore the database backups from A to P or use MUPIP LOAD to load the data.</p></li>
<li class="listitem"><p>Start a Source Server on P with -UPDOK to indicate local updates are enabled on P.</p></li>
<li class="listitem"><p>Start the Receiver Server on P with the -UPDATERESYNC=&lt;/path/to/bkup-orig-repl-inst-file&gt;
        qualifier and -INITIALIZE. The -INITIALIZE indicates this is the first time A and P are replicating.</p></li>
</ul></div>
<p>In this case, the Receiver Server uses the current journal sequence number in the &lt;/path/to/bkup-orig-repl-inst-file&gt; as the point where A starts sending journal records. GT.M updates the
stream sequence number of Stream # 1 in the instance file on P to reflect this value. From this point, GT.M maps the journal sequence number on A to a stream journal sequence number (for example, stream
# 1) on P.</p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="proc4"></a>Setting up an A&#8594;P configuration for the first time if P is an existing instance (having
its own set of updates) </h3></div></div></div>
<p>On P:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Turn off passive Source Server and Receiver Server (if they are active).</p></li>
<li class="listitem"><p>Turn off replication and run down the database. </p></li>
</ul></div>
<p>On A:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>Take
a backup of the replication instance file and the database together with BACKUP -REPLINSTANCE and transfer it to P. If A's instance file was also freshly created, take the backup while the Source Server is running on the originating instance. This ensures that the backed up replication instance file contains at least one history record.</p></li></ul></div>
<p>On P: </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Do not create a new instance file. Continue using the existing instance file to preserve updates that have already occurred on P.</p></li>
<li class="listitem"><p>Start the Source Server with -UPDOK to indicate that local updates are enabled on P.</p></li>
<li class="listitem"><p>Start the Receiver Server  with the -UPDATERESYNC=&lt;/path/to/bkup-orig-repl-inst-file&gt; qualifier and -INITIALIZE. The -INITIALIZE indicates this is the first time A and P are replicating.</p></li>
</ul></div>
<p>The Receiver Server uses the current journal sequence number in the &lt;/path/to/bkup-orig-repl-inst-file&gt;
 as the point where A starts sending journal records. GT.M updates the stream sequence number (for example, of Stream # 1) in the instance file on P to reflect this value. Going forward, the journal sequence number on A will always map to a stream journal sequence number (for example, of stream # 1) on P.</p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch07s02.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="ch07.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="replication.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Implementing Replication and Recovery </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Commands and Qualifiers</td>
</tr>
</table>
</div>
</body>

<!-- Mirrored [from host tinco.pair.com [file /bhaskar/gtm/doc/books/ao/UNIX_manual/ch07s03.html]] -->
</html>
