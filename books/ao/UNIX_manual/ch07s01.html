<html>
<HEAD><META HTTP-EQUIV="Pragma" CONTENT="no-cache"><META HTTP-EQUIV="Expires" CONTENT="-1">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Introduction</title>
<link rel="stylesheet" href="gtm.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
<link rel="home" href="index.html" title="GT.M Administration and Operations Guide">
<link rel="up" href="ch07.html" title="Chapter 7. Database Replication">
<link rel="prev" href="ch07.html" title="Chapter 7. Database Replication">
<link rel="next" href="ch07s02.html" title="Implementing Replication and Recovery">
<link rel="copyright" href="ln-idp65672272.html" title="Legal Notice">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<table width="100%" summary="Navigation header">
<tr><th colspan="3" align="center">Introduction</th></tr>
<tr>
<td width="20%" align="left">
<a accesskey="p" href="ch07.html">Prev</a> </td>
<th width="60%" align="center">Chapter 7. Database Replication</th>
<td width="20%" align="right"> <a accesskey="n" href="ch07s02.html">Next</a>
</td>
</tr>
</table>
<hr>
</div>
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">GT.M Administration and Operations Guide</a></span> &gt; <span class="breadcrumb-link"><a href="ch07.html">Database Replication</a></span> &gt; <span class="breadcrumb-node">Introduction</span>
</div>
<div class="sect1">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="theory_of_operation"></a>Introduction<a class="indexterm" name="idp69231200"></a>
</h2></div></div></div>
<p>GT.M replication provides logical equivalence between multiple databases. It facilitates continuous application availability, real-time decision support, warehousing, analytics, and 
auditing. There are two types of replication:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Business Continuity (BC) replication</p></li>
<li class="listitem"><p>Supplementary Instance (SI) replication</p></li>
</ol></div>
<p>BC replication helps provide business continuity for GT.M databases. Updates applied at an originating instance replicate in near real-time to a replicating instance. To help ensure this consistency, BC replication prohibits locally generated database updates on a replicating secondary instance. For example with instances named A and B, business logic processed on instance A can be streamed to instance B so that should A ever go down, B can immediately take over and provide continuity. In order to ensure that B produces results consistent with A, B can contain only material state information that is also in A.</p>
<p>Updates applied at an originating instance replicate in near real-time to as many as sixteen replicating instances each of which can propagate further down to as many as sixteen replicating instances. Each replicating instance can further replicate to as any as sixteen replicating instances and so on. When an originating instance becomes unavailable, any downstream instance can become the replacement originating instance to keep the application available.</p>
<p>In the following illustration, A is the originating primary instance and B and C are its replicating instances. C is also a propagating primary instance because it further replicates to D. This BC replication configuration can also be described as a B&#8592;A&#8594;C&#8594;D configuration.</p>
<img src="ao_figures/bc_repl.gif"><p>BC replication is intended for mission-critical applications that must be available 24 hours a day, 365 days a year, in the face of both unplanned events (such as system crashes) as well planned events (such as system and software upgrades).</p>
<p>With BC replication, you can create a logical multi-site (LMS) replication configuration for mission critical applications that must always be available not only in face of unplanned events (such as system or data center failures) but also in the face of planned events such as computing platform upgrades, OS upgrades, GT.M upgrades and even application upgrades. Deploying a BC replication configuration should take into account available network capacities, operational preferences, risk assessments, and business continuity requirements.</p>
<p>With SI replication, an instance has the ability to receive replication stream from another instance and at the same time execute its own business logic to compute and commit its own updates. In the following B&#8592;A&#8594;P&#8594;Q replication configuration, instance P can execute its own business logic to compute and commit its updates to its own replicated regions while receiving a replication stream from A. A is an originating primary instance, P is a supplementary originating instance, B is a secondary (standby) instance for A and Q is a secondary (standby) supplementary instance for P. In this configuration, B and Q are only permitted to receive and apply replication streams from their respective originating instances. Unlike P, B and Q cannot generate their own updates. </p>
<img src="ao_figures/si_repl.gif"><p>SI replication is a general purpose mechanism whose utility includes applications such as real-time decision support, warehousing, analytics, and auditing.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Note]" src="images/note.jpg"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>In this book, instances {A, B, C...} denote instances setup for use as business continuity instances and instances {P, Q, R...} are set up for use as supplementary instances.  An instance is a supplementary instance if its replication instance file is created with the -supplementary qualifier. </p></td></tr>
</table></div>
<p>GT.M imposes no distance limits between instances. You can place instances 20,000 kilometers apart (the circumference of Planet Earth is 40,000 kilometers) or locally within the same data center.</p>
<p>Using TCP connections, GT.M replicates between instances with heterogeneous stacks of hardware, operating system, endian architecture and even GT.M releases. A GT.M instance can source a BC replication stream to, or receive a BC replication stream from, GT.M V5.1-000 or later.  However, SI replication requires both source and receive side must be GT.M V5.5-000 or later. GT.M replication can even be used in configurations with different application software versions, including many cases where the application software versions have different database schema. This also means that a number of inexpensive systems - such as GNU/Linux commodity servers - can be placed in locations throughout an organization. Replicating instances can be used for decision support, reporting, and analytics. Because GT.M databases can be encrypted, these commodity servers are potentially usable in environments outside secure data centers as long as their operating systems and software are secured.</p>
<p>GT.M replication requires journaling to be enabled and turned on for replicated regions. Unreplicated regions (for example, global variables containing information that is meaningful only on one instance and only as long as the instance is operating - such as process ids, temporary working files, and so on) need not be replicated or journaled.</p>
<p>GT.M replication mechanism is designed in such a way that a network failure between instances will not stop an application from being available, which is a limitation of techniques such as high availability clustering<sup>[<a name="idp69313136" href="ch07s01.html#ftn.idp69313136" class="footnote">1</a>]</sup>. There are mechanisms in place for edge cases like processing "in flight" transactions and common cases like handling backlog of updates after recovery from a network failure. While it is not possible to provide absolute continuity of business in our imperfect universe, an LMS configuration gives you the flexibility to choose application configurations that match your investment to a risk level that best meets the business needs of your organization.</p>
<p>GT.M replication is asynchronous, which in turn means that the source and receiver ends of a replication connection are at an identical state when there is no activity underway. To maintain consistency, and to restore it when restarting a replication connection, instances maintain a common, mutually coherent, instance-wide serial number called a journal sequence number. Each journal sequence number is tagged with two fields that identify the source of the update- a stream # that can take on values 0 through 15 and a stream sequence number (the journal sequence number of the update on the originating instance). Because replication deals with an entire global variable namespace, regardless of the mapping of global variables to database files, all updates participate in this numbering, even when modifying different database files. All updates in a transaction (within the TSTART/TCOMMIT boundary) have the same journal sequence number. Each update outside a transaction boundary has a unique journal sequence number.</p>
<p>On instances that do not include updates from supplementary logic, the journal sequence number and the stream sequence number are the same.</p>
<p>Suppose sequence numbers in P are 100, 101, and 102. If the first and third transactions are locally generated and the second is replicated, the tagged journal sequence numbers might be something like {100,0,10}, {101,1,18}, {102,0,11}. The 0 stream # for 100 and 102 indicates those transactions are generated locally on P whereas stream # 1 indicates those transactions were generated in A. If P needs to roll {101,1,18} off its database in order to resychronize replication with A, database update serialization also requires it to roll {102,0,11} off as well, and both will appear in the Unreplicated Transaction Log (also known as Lost Transaction File).</p>
<p>The journal sequence number on A becomes the stream sequence number on P for transactions replicated from A to P. In the example, the transaction that has the P sequence number of 101 has the sequence number 18 on A and B. The replication instance file in P contains information that allows GT.M to determine this mapping, so that when P rolls {101,1,18} off its database, A knows that P has rolled off its transaction 18, and can include that when catching P up.</p>
<p>If P in turn implements BC replication to another instance Q, the tagging is propagated to Q, such that if A and P both go down (e.g., if they are co-located in a data center that loses electricity), B and C can take over the functions of A and P respectively, and Q can perform any synchronization needed in order to start accepting a replication stream from B as being a continuation of the updates generated by A, and B in turn accepts Q as the successor to P.</p>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="lmsgroup"></a>LMS Group</h3></div></div></div>
<p>An LMS Group is a set of one or more instances that receive updates from the same originating primary instance and represent the same logical state. GT.M implicitly forms an LMS Group by storing the identification of the originating primary instance in the replication instance file of each replicating instance. There are two types of LMS Groups:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>BC Group: An LMS Group whose originating primary instance is a BC instance. A BC Group can have BC and SI instances as members.</p></li>
<li class="listitem"><p>SI Group: An LMS Group whose originating primary instance is an SI instance. An SI Group can have only SI instances as members and can receive replication only from a BC member of a BC Group.</p></li>
</ol></div>
<p>BC members of a BC Group can replicate downstream to other BC and SI groups whereas an SI Group cannot replicate downstream to other groups.</p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Important]" src="images/important.jpg"></td>
<th align="left">Important</th>
</tr>
<tr><td align="left" valign="top"><p>Instances can change their roles within an LMS group but they cannot move between groups, however data from one instance / group can be loaded into another group.</p></td></tr>
</table></div>
<p>The following example illustrates a replication configuration where instance A from A's BC Group replicates to instance Q in Q's SI Group.</p>
<pre class="programlisting">+-----------------+
|      + A +      |
|      | | |      |  
|B&#8592;----| | |----&#8594;P|
+--------|--------+
         |
         |
+--------V--------+
|      + Q +      |
|      |   |      |
|R&#8592;----|   |----&#8594;S|
+-----------------+</pre>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Note]" src="images/note.jpg"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>In this replication configuration, instance B can also replicate to instance Q. However, instance P cannot replicate to an instance in Q's group because it is an SI member of A's BC group.</p></td></tr>
</table></div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="db_trans_no"></a>Database Transaction Number</h3></div></div></div>
<p>Every transaction applied to a database file increments the database transaction number for that file. Each block records the database transaction number at which it was updated, and the Current transaction field in the file header shows the value for the next transaction or mini-transaction to use. The following database file header fields all show database transaction numbers: Last Record Backup, Last Database Backup, Last Bytestream Backup, Maximum TN, and Maximum TN Warn.</p>
<p>Database transaction numbers are currently unsigned 64-bit integers.</p>
<p>While database activity uses database transaction numbers sequentially, not every transaction number can be found in a database block. For a Kill increments the database transaction number, but can remove blocks with earlier database transaction numbers from the database.</p>
<p>Note that database transaction numbers are updated in memory and only periodically flushed to secondary storage, so in cases of abnormal shutdown, the on-disk copies in the file header might be somewhat out-of-date.</p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="jnl_seq_no"></a>Journal Sequence Number</h3></div></div></div>
<p>While the database transaction number is specific to a database file, replication imposes a serialization of transactions across all replicated regions. As each transaction is placed in the Journal Pool it is assigned the next journal sequence number. When a database file in a replicated instance is updated, the Region Seqno field in the file header records the journal sequence number for that transaction. The journal sequence number for an instance is the maximum Region Seqno of any database file in that instance. While it uses them in processing, GT.M stores journal sequence numbers only in journal files. In database file headers, Zqgblmod Seqno and Zqgblmod Trans are journal sequence numbers.</p>
<p>Except for transactions in Unreplicated Transaction Logs, the journal sequence number of a transaction uniquely identifies that transaction on the originating primary instance and on all replicating secondary instances. When replicated via SI replication, the journal sequence number becomes a stream sequence number (see below) and propagated downstream, thus maintaining the unique identity of each transaction.</p>
<p>Journal sequence numbers cannot have holes - missing journal sequence numbers are evidence of abnormal database activity, including possible manual manipulation of the transaction history or database state.</p>
<p>Journal sequence numbers are 60-bit unsigned integers.</p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="stm_seq_no"></a>Stream Sequence Number</h3></div></div></div>
<p>The receiver of a SI replication stream has both transactions that it receives via replication as well as transactions that it computes locally from business logic. As discussed earlier, while journal sequence numbers can uniquely identify a series of database updates, they cannot identify the source of those updates. Therefore, we have the concept of a stream sequence number.</p>
<p>On an originating primary instance that is not the recipient of an SI replication stream, the journal sequence number and the stream sequence number are the same.</p>
<p>On a primary instance that is the recipient of an SI replication stream, the journal sequence numbers uniquely identify and serialize all updates, whether received from replication or locally generated. However, there is also a stream sequence number, which is the journal sequence number for locally generated transactions, and for replicated updates, the combination of a non-zero 4 bit tag (that is, with values 1 through 15) and the journal sequence number for the transaction on the system from which it was replicated. These stream sequence numbers are propagated to downstream replicating secondary instances.</p>
<p>Stream sequence numbers are 64-bit unsigned integers.</p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="repl_gesz"></a>Instance Bound Global Directories </h3></div></div></div>
<p>GDE provides a mapping option (GDE CHANGE -INSTANCE -FILE_NAME=&lt;replication_instance_file&gt;) to bind a global directory with a replication instance file. With this mapping option, GT.M processes give precedence to the &lt;replication_instance_file&gt; stored in GDE over any (or no) value of the gtm_repl_instance environment variable. This makes it possible for a GT.M process to update globals in the replicated regions of a different replication instance than that defined by the gtm_repl_instance environment variable. </p>
<p>Without this mapping option (that is, GDE CHANGE -INSTANCE -FILE_NAME= ""), an attempt to update a global bound to an instance other than the default replication instance file specified with the environment variable gtm_repl_instance produces the REPLINSTMISMTCH error:  </p>
<pre class="programlisting">GTM&gt;set ^|"/path/to/unbound/XXXX.gld"|replnamespace="Hello from same system instance YYYY"
%GTM-E-REPLINSTMISMTCH, Process has replication instance file YYYY.repl (jnlpool shmid = 9999) open but database XXXX.dat is bound to instance file XXXX.repl (jnlpool shmid = 8888)</pre>
<p>The following restrictions apply for making updates to the replicated regions of an instance bound global directory:</p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>A replication instance file cannot share any region with another instance file.</p></li>
<li class="listitem"><p>The Source Servers of all the instances have properly set up Replication Journal Pools.</p></li>
<li class="listitem"><p>A TP transaction or a trigger, as it always executes within a TP transaction, must always restrict updates to globals in one replicating instance.</p></li>
</ol></div>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Note]" src="images/note.jpg"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>Processes other than MUPIP CREATE only use mapping information in a global directory, including collation, instance file association and name mapping, and ignore other (non-mapping) global directory database characteristics.</p></li>
<li class="listitem"><p>When Instance Freeze is enabled (gtm_custom_errors is appropriately defined), a process attaches a region to an instance at the first access to the region; the access may be a read or a VIEW/$VIEW(). Otherwise, the process attaches to a region at the first update to that region. When the mappings are correct, this difference does not matter.</p></li>
<li class="listitem"><p>A GT.M process can always update globals that are not in a replicated region.</p></li>
<li class="listitem"><p>Use $VIEW("JNLPOOL") to determine the state of the current Journal Pool. $VIEW("JNLPOOL") returns the replication instance file name for the current Journal Pool and an empty string when there is no Journal Pool. Note that the current Journal Pool may not be associated with the last global accessed by an extended reference.</p></li>
</ul></div></td></tr>
</table></div>
<p> </p>
<div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important: Important">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Important]" src="images/important.jpg"></td>
<th align="left">Important</th>
</tr>
<tr><td align="left" valign="top"><p>We believe that this functionality may interest both application developers and database administrators. Because this functionality has a wide variety of creative use cases when combined with other GT.M features like Triggers, TP, serialization with LOCK controls, replication filters, etc., we encourage GT.M users to explore this feature and provide us with feedback.</p></td></tr>
</table></div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="sppl_exampls"></a>Examples</h3></div></div></div>
<p>To make the following scenarios easier to understand, each update is prefixed with the system where it was originally generated and the sequence number on that system and any BC replicating secondary instances.</p>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="simp_examp"></a>Simple Example</h4></div></div></div>
<p>The three systems initially operate in roles O (Originating primary instance), R (BC Replicating secondary instance) and S (recipient of an SI replication stream).</p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>Ardmore</strong></span></p>
            </th>
<th>
              <p><span class="italic">BrynMawr</span></p>
            </th>
<th>
              <p><span class="underline">Malvern</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span></p>
            </td>
<td>
              <p><span class="bold"><strong>Ardmore</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">BrynMawr</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A98</strong></span> and <span class="underline">Malvern</span> as a SI that includes transaction number <span class="bold"><strong>A97</strong></span>, interspersed with locally generated updates. Updates are recorded in each instance's journal files using before-image journaling.</p>
            </td>
</tr>
<tr>
<td>
              <p>Crashes</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span></p>
            </td>
<td>
              <p>... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span></p>
            </td>
<td>
              <p>When an event disables <span class="bold"><strong>Ardmore</strong></span>, <span class="italic">BrynMawr</span> becomes the new originating primary, with <span class="bold"><strong>A98</strong></span> as the latest transaction in its database, and starts processing application logic to maintain business continuity. In this case where <span class="underline">Malvern</span> is not ahead of <span class="italic">BrynMawr</span>, the Receiver Server at <span class="underline">Malvern</span> can remain up after <span class="bold"><strong>Ardmore</strong></span> crashes. When <span class="italic">BrynMawr</span> connects, its Source Server and <span class="underline">Malvern</span>'s Receiver Server confirms that <span class="italic">BrynMawr</span> is not behind <span class="underline">Malvern</span> with respect to updates received from <span class="bold"><strong>Ardmore</strong></span>, and SI replication from <span class="italic">BrynMawr</span> picks up where replication from <span class="bold"><strong>Ardmore</strong></span> left off.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="italic">B61</span>, <span class="underline">M40</span></p>
            </td>
<td>
              <p><span class="underline">Malvern</span> operating as a supplementary instance to <span class="italic">BrynMawr</span> replicates transactions processed on <span class="italic">BrynMawr</span>, and also applies its own locally generated updates. Although <span class="bold"><strong>A98</strong></span> was originally generated on <span class="bold"><strong>Ardmore</strong></span>, <span class="underline">Malvern</span> received it from <span class="italic">BrynMawr</span> because <span class="bold"><strong>A97</strong></span> was the common point between <span class="italic">BrynMawr</span> and <span class="underline">Malvern</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="italic">B61</span>, <span class="underline">M40</span>, <span class="italic">B62</span>, <span class="italic">B63</span></p>
            </td>
<td>
              <p><span class="underline">Malvern</span>, continuing as a supplementary instance to <span class="italic">BrynMawr</span>, replicates transactions processed on <span class="italic">BrynMawr</span>, and also applies its own locally generated updates. <span class="bold"><strong>Ardmore</strong></span> meanwhile has been repaired and brought online. It has to roll transaction <span class="bold"><strong>A99</strong></span> off its database into an Unreplicated Transaction Log before it can start operating as a replicating secondary instance to <span class="italic">BrynMawr</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span>, B65</p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="italic">B61</span>, <span class="underline">M40</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="underline">M41</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>Having rolled off transactions into an Unreplicated Transaction Log, <span class="bold"><strong>Ardmore</strong></span> can now operate as a replicating secondary instance to <span class="italic">BrynMawr</span>. This is normal BC Logical Multi-Site operation. <span class="italic">BrynMawr</span> and <span class="underline">Malvern</span> continue operating as originating primary instance and supplementary instance.</p>
            </td>
</tr>
</tbody>
</table></div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="idp69493296"></a>Ensuring Consistency with Rollback</h4></div></div></div>
<p>Whereas in the last example <span class="underline">Malvern</span> was not ahead when starting SI replication from <span class="italic">BrynMawr</span>, in this example, asynchronous processing has left it ahead and must rollback its database state before it can receive the replication stream.</p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>Ardmore</strong></span></p>
            </th>
<th>
              <p><span class="italic">BrynMawr</span></p>
            </th>
<th>
              <p><span class="underline">Malvern</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="underline">M40</span></p>
            </td>
<td>
              <p><span class="bold"><strong>Ardmore</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">BrynMawr</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A97</strong></span> and <span class="underline">Malvern</span> as a SI that includes transaction number <span class="bold"><strong>A98</strong></span>, interspersed with locally generated updates. Updates are recorded in each instance's journal files using before-image journaling.</p>
            </td>
</tr>
<tr>
<td>
              <p>Crashes</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="underline">M40</span></p>
            </td>
<td>
              <p>When an event disables <span class="bold"><strong>Ardmore</strong></span>, <span class="italic">BrynMawr</span> becomes the new originating primary, with <span class="bold"><strong>A97</strong></span> the latest transaction in its database. <span class="underline">Malvern</span> cannot immediately start replicating from <span class="italic">BrynMawr</span> because the database states would not be consistent - while <span class="italic">BrynMawr</span> does not have <span class="bold"><strong>A98</strong></span> in its database and its next update may implicitly or explicitly depend on that absence, <span class="underline">Malvern</span> does, and may have relied on <span class="bold"><strong>A98</strong></span> to compute <span class="underline">M39</span> and <span class="underline">M40</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="italic">B61</span></p>
            </td>
<td>
              <p>For <span class="underline">Malvern</span> to accept replication from <span class="italic">BrynMawr</span>, it must roll off transactions generated by <span class="bold"><strong>Ardmore</strong></span>, (in this case <span class="bold"><strong>A98</strong></span>) that <span class="italic">BrynMawr</span> does not have in its database, as well as any additional transactions generated and applied locally since transaction number <span class="bold"><strong>A98</strong></span> from <span class="bold"><strong>Ardmore</strong></span>.<sup>[<a name="idp69610816" href="ch07s01.html#ftn.idp69610816" class="footnote">a</a>]</sup> This rollback is accomplished with a MUPIP JOURNAL -ROLLBACK -FETCHRESYNC operation on <span class="underline">Malvern</span>.<sup>[<a name="idp69617936" href="ch07s01.html#ftn.idp69617936" class="footnote">b</a>]</sup> These rolled off transactions (<span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="underline">M40</span>) go into the Unreplicated Transaction Log and can be subsequently reprocessed by application code.<sup>[<a name="idp69612912" href="ch07s01.html#ftn.idp69612912" class="footnote">c</a>]</sup> Once the rollback is completed, <span class="underline">Malvern</span> can start accepting replication from <span class="italic">BrynMawr</span>.<sup>[<a name="idp69628160" href="ch07s01.html#ftn.idp69628160" class="footnote">d</a>]</sup> <span class="italic">BrynMawr</span> in its Originating Primary role processes transactions and provides business continuity, resulting in transactions <span class="italic">B61</span> and <span class="italic">B62</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="underline">M39</span>a, <span class="underline">M40</span>a, <span class="italic">B63</span></p>
            </td>
<td>
              <p><span class="underline">Malvern</span> operating as a supplementary instance to <span class="italic">BrynMawr</span> replicates transactions processed on <span class="italic">BrynMawr</span>, and also applies its own locally generated updates. Note that <span class="underline">M39</span>a &amp; <span class="underline">M40</span>a may or may not be the same updates as the <span class="underline">M39</span> &amp; <span class="underline">M40</span> previously rolled off the database.</p>
            </td>
</tr>
</tbody>
<tbody class="footnotes"><tr><td colspan="4">
<div class="footnote"><p><sup>[<a name="ftn.idp69610816" href="ch07s01.html#idp69610816" class="para">a</a>] </sup>As this rollback is more complex, may involve more data than the regular LMS rollback, and may involve reading journal records sequentially; it may take longer.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.idp69617936" href="ch07s01.html#idp69617936" class="para">b</a>] </sup>In scripting for automating operations, there is no need to explicitly test whether <span class="italic">BrynMawr</span> is behind <span class="underline">Malvern</span> - if it is behind, the Source Server will fail to connect and report an error, which automated shell scripting can detect and effect a rollback on <span class="underline">Malvern</span> followed by a reconnection attempt by <span class="italic">BrynMawr</span>. On the other hand, there is no harm in <span class="underline">Malvern</span> routinely performing a rollback before having <span class="italic">BrynMawr</span> connect - if it is not ahead, the rollback will be a no-op. This characteristic of replication is unchanged from releases prior to V5.5-000.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.idp69612912" href="ch07s01.html#idp69612912" class="para">c</a>] </sup>GT.M's responsibility for them ends once it places them in the Unreplicated Transaction Log.</p></div>
<div class="footnote"><p><sup>[<a name="ftn.idp69628160" href="ch07s01.html#idp69628160" class="para">d</a>] </sup>Ultimately, business logic must determine whether the rolled off transactions can simply be reapplied or whether other reprocessing is required. GT.M's $ZQGBLMOD() function can assist application code in determining whether conflicting updates may have occurred.</p></div>
</td></tr></tbody>
</table></div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="rollback_design"></a>Rollback Not Desired or Required by Application Design</h4></div></div></div>
<p>In the example above, for <span class="underline">Malvern</span> to start accepting SI replication from <span class="italic">BrynMawr</span> with consistency requires it to rollback its database because it is ahead of <span class="italic">BrynMawr</span>. There may be applications where the design of the application is such that this rollback neither required nor desired. GT.M provides a way for SI replication to start in this situation without rolling transactions off into an Unreplicated Transaction File.</p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>Ardmore</strong></span></p>
            </th>
<th>
              <p><span class="italic">BrynMawr</span></p>
            </th>
<th>
              <p><span class="underline">Malvern</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="underline">M40</span></p>
            </td>
<td>
              <p><span class="bold"><strong>Ardmore</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">BrynMawr</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A97</strong></span> and <span class="underline">Malvern</span> as a SI that includes transaction number <span class="bold"><strong>A98</strong></span>, interspersed with locally generated updates. Updates are recorded in each instance's journal files using before-image journaling.</p>
            </td>
</tr>
<tr>
<td>
              <p>Crashes</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="underline">M40</span></p>
            </td>
<td>
              <p>When an event disables <span class="bold"><strong>Ardmore</strong></span>, <span class="italic">BrynMawr</span> becomes the new originating primary, with <span class="bold"><strong>A97</strong></span> the latest transaction in its database and starts processing application logic. Unlike the previous example, in this case, application design permits (or requires) <span class="underline">Malvern</span> to start replicating from <span class="italic">BrynMawr</span> even though <span class="italic">BrynMawr</span> does not have <span class="bold"><strong>A98</strong></span> in its database and <span class="underline">Malvern</span> may have relied on <span class="bold"><strong>A98</strong></span> to compute <span class="underline">M39</span> and <span class="underline">M40</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="underline">M40</span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>With its Receiver Server started with the -noresync option, <span class="underline">Malvern</span> can receive a SI replication stream from <span class="italic">BrynMawr</span>, and replication starts from the last common transaction shared by <span class="italic">BrynMawr</span> and <span class="underline">Malvern</span>. Notice that on <span class="italic">BrynMawr</span> no <span class="bold"><strong>A98</strong></span> precedes <span class="italic">B61</span>, whereas it does on <span class="underline">Malvern</span>, i.e., <span class="underline">Malvern</span> was ahead of <span class="italic">BrynMawr</span> with respect to the updates generated by <span class="bold"><strong>Ardmore</strong></span>.</p>
            </td>
</tr>
</tbody>
</table></div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="two_ori_pri_fail"></a>Two Originating Primary Failures</h4></div></div></div>
<p>Now consider a situation where <span class="bold"><strong>Ardmore</strong></span> and <span class="underline">Malvern</span> are located in one data center, with BC replication to <span class="italic">BrynMawr</span> and <span class="italicunderline">Newtown</span> respectively, located in another data center. When the first data center fails, the SI replication from <span class="bold"><strong>Ardmore</strong></span> to <span class="underline">Malvern</span> is replaced by SI replication from <span class="italic">BrynMawr</span> to <span class="italicunderline">Newtown</span>.</p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>Ardmore</strong></span></p>
            </th>
<th>
              <p><span class="italic">BrynMawr</span></p>
            </th>
<th>
              <p><span class="underline">Malvern</span></p>
            </th>
<th>
              <p><span class="italicunderline">Newtown</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">M37</span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M38</span></p>
            </td>
<td>
              <p>R: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">M37</span></p>
            </td>
<td>
              <p><span class="bold"><strong>Ardmore</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">BrynMawr</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A98</strong></span> and <span class="underline">Malvern</span> as a SI that includes transaction number <span class="bold"><strong>A97</strong></span>, interspersed with locally generated updates. <span class="underline">Malvern</span> in turn replicates to <span class="italicunderline">Newtown</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>Goes down with the data center</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>Goes down with the data center</p>
            </td>
<td>
              <p>... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">M37</span></p>
            </td>
<td>
              <p>When a data center outage disables <span class="bold"><strong>Ardmore</strong></span>, and <span class="underline">Malvern</span>, <span class="italic">BrynMawr</span> becomes the new originating primary, with <span class="bold"><strong>A98</strong></span> as the latest transaction in its database and starts processing application logic to maintain business continuity. <span class="italicunderline">Newtown</span> can receive the SI replication stream from <span class="italic">BrynMawr</span>, without requiring a rollback since the receiver is not ahead of the source.</p>
            </td>
</tr>
<tr>
<td>
              <p>-</p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p>-</p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">M37</span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">N73</span>, <span class="italic">B61</span>, <span class="italicunderline">N74</span>, <span class="italic">B62</span></p>
            </td>
<td>
              <p><span class="italicunderline">Newtown</span> receives SI replication from <span class="italic">BrynMawr</span> and also applies its own locally generated updates. Although <span class="bold"><strong>A97</strong></span> and <span class="bold"><strong>A98</strong></span> were originally generated on <span class="bold"><strong>Ardmore</strong></span>, <span class="italicunderline">Newtown</span> receives them from <span class="italic">BrynMawr</span>. <span class="italicunderline">Newtown</span> also computes and applies locally generated updates</p>
            </td>
</tr>
<tr>
<td>
              <p>... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">M37</span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M38</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">M37</span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">N73</span>, <span class="italic">B61</span>, <span class="italicunderline">N74</span>, <span class="italic">B62</span>, <span class="italicunderline">N75</span>, <span class="italic">B63</span>, <span class="italicunderline">N76</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>While <span class="italic">BrynMawr</span> and <span class="italicunderline">Newtown</span>, keep the enterprise in operation, the first data center is recovered. Since <span class="bold"><strong>Ardmore</strong></span> has transactions in its database that were not replicated to <span class="italic">BrynMawr</span> when the latter started operating as the originating primary instance, and since <span class="underline">Malvern</span> had transactions that were not replicated to <span class="italicunderline">Newtown</span> when the latter took over, <span class="bold"><strong>Ardmore</strong></span> and <span class="underline">Malvern</span> must now rollback their databases and create Unreplicated Transaction Files before receiving BC replication streams from <span class="italic">BrynMawr</span> and <span class="italicunderline">Newtown</span> respectively. <span class="bold"><strong>Ardmore</strong></span> rolls off <span class="bold"><strong>A98</strong></span> and <span class="bold"><strong>A99</strong></span>, <span class="underline">Malvern</span> rolls off <span class="bold"><strong>A97</strong></span> and <span class="underline">M38</span>.</p>
            </td>
</tr>
<tr>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="italic">B61</span>, <span class="italic">B62</span>, <span class="italic">B63</span>, <span class="italic">B64</span>, B65</p>
            </td>
<td>
              <p>R: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">M37</span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">N73</span>, <span class="italic">B61</span>, <span class="italicunderline">N74</span>, <span class="italic">B62</span>, <span class="italicunderline">N75</span>, <span class="italic">B63</span>, <span class="italicunderline">N76</span>, <span class="italic">B64</span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="underline">M37</span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="italicunderline">N73</span>, <span class="italic">B61</span>, <span class="italicunderline">N74</span>, <span class="italic">B62</span>, <span class="italicunderline">N75</span>, <span class="italic">B63</span>, <span class="italicunderline">N76</span>, <span class="italic">B64</span>, <span class="italicunderline">N77</span></p>
            </td>
<td>
              <p>Having rolled off transactions into an Unreplicated Transaction Log, <span class="bold"><strong>Ardmore</strong></span> can now operate as a replicating secondary instance to <span class="italic">BrynMawr</span>. This is normal BC Logical Multi-Site operation. <span class="italic">BrynMawr</span> and <span class="underline">Malvern</span> continue operating as originating primary instance and supplementary instance. Note that having rolled <span class="bold"><strong>A97</strong></span> off its database, <span class="underline">Malvern</span> receives that transaction from <span class="italicunderline">Newtown</span> as it catches up.</p>
            </td>
</tr>
</tbody>
</table></div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="replication_on_rlbk"></a>Replication and Online Rollback</h4></div></div></div>
<p>Consider the following example where <span class="bold"><strong>Ardmore</strong></span> rolls back its database in state space while an application is in operation. using the MUPIP JOURNAL -ROLLBACK -BACKWARD -ONLINE feature. </p>
<div class="informaltable"><table border="1">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
              <p><span class="bold"><strong>Ardmore</strong></span></p>
            </th>
<th>
              <p><span class="italic">BrynMawr</span></p>
            </th>
<th>
              <p><span class="underline">Malvern</span></p>
            </th>
<th>
              <p>Comments</p>
            </th>
</tr></thead>
<tbody>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="bold"><strong>A98</strong></span>, <span class="bold"><strong>A99</strong></span></p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span></p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="underline">M40</span></p>
            </td>
<td>
              <p><span class="bold"><strong>Ardmore</strong></span> as an originating primary instance at transaction number <span class="bold"><strong>A99</strong></span>, replicates to <span class="italic">BrynMawr</span> as a BC replicating secondary instance at transaction number <span class="bold"><strong>A97</strong></span> and <span class="underline">Malvern</span> as a SI that includes transaction number <span class="bold"><strong>A98</strong></span>, interspersed with locally generated updates. Updates are recorded in each instance's journal files using before-image journaling.</p>
            </td>
</tr>
<tr>
<td>
              <p>Rolls back to <span class="bold"><strong>A96</strong></span> with <span class="bold"><strong>A97</strong></span> through <span class="bold"><strong>A99</strong></span> in the Unreplicated Transaction Log</p>
            </td>
<td>
              <p>Rolls back automatically to <span class="bold"><strong>A96</strong></span> (assume Receiver Server started with -autorollback - refer to the V5.5-000 Release Notes for details.</p>
            </td>
<td>
              <p>-</p>
            </td>
<td>
              <p>Instances receiving a replication stream from <span class="bold"><strong>Ardmore</strong></span> can be configured to rollback automatically when <span class="bold"><strong>Ardmore</strong></span> performs an online rollback by starting the Receiver Server with -autorollback. If <span class="underline">Malvern</span>'s Receiver Server is so configured, it will roll <span class="bold"><strong>A97</strong></span> through <span class="underline">M40</span> into an Unreplicated Transaction Log. This scenario is straightforward. But with the -noresync qualifier, the Receiver Server can be started configured to simply resume replication without rolling back, and that scenario is developed here.</p>
            </td>
</tr>
<tr>
<td>
              <p>O: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>a, <span class="bold"><strong>A98</strong></span>a, <span class="bold"><strong>A99</strong></span>a</p>
            </td>
<td>
              <p>R: ... <span class="bold"><strong>A95</strong></span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>a, <span class="bold"><strong>A98</strong></span>a</p>
            </td>
<td>
              <p>S: ... <span class="underline">M34</span>, <span class="bold"><strong>A95</strong></span>, <span class="underline">M35</span>, <span class="underline">M36</span>, <span class="bold"><strong>A96</strong></span>, <span class="bold"><strong>A97</strong></span>, <span class="underline">M37</span>, <span class="underline">M38</span>, <span class="bold"><strong>A98</strong></span>, <span class="underline">M39</span>, <span class="underline">M40</span>, <span class="bold"><strong>A97</strong></span>a, <span class="underline">M41</span>, <span class="bold"><strong>A98</strong></span>a, <span class="underline">M42</span></p>
            </td>
<td>
              <p>Transactions <span class="bold"><strong>A97</strong></span>a through <span class="bold"><strong>A99</strong></span>a are different transactions from <span class="bold"><strong>A97</strong></span> through <span class="bold"><strong>A99</strong></span> (which are in an Unreplicated Transaction File on <span class="bold"><strong>Ardmore</strong></span> and must be reprocessed). Note that <span class="underline">Malvern</span> has both the original <span class="bold"><strong>A97</strong></span> and <span class="bold"><strong>A98</strong></span> as well as <span class="bold"><strong>A97</strong></span>a and <span class="bold"><strong>A98</strong></span>a. <span class="bold"><strong>A99</strong></span> was never replicated to <span class="underline">Malvern</span> - <span class="bold"><strong>Ardmore</strong></span> rolled back before it was replicated, and <span class="bold"><strong>A99</strong></span>a has not yet made it to <span class="underline">Malvern</span> (it will soon, unless <span class="bold"><strong>Ardmore</strong></span> rolls back again).</p>
            </td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="si_repl_limits"></a>Limitations - SI Replication</h3></div></div></div>
<p>starting V5.5-000, GT.M does not support replication between platforms with GT.M releases prior to V5.1-000. To upgrade to GT.M V5.5-000, first upgrade to GT.M V5.1-000 or later as an intermediate step.</p>
<p>Although a receiver of SI replication can source a BC replication stream for downstream propagation, it cannot source an SI replication stream. So, in the example above, while <span class="underline">Malvern</span> can receive SI replication from <span class="bold"><strong>Ardmore</strong></span> or <span class="italic">BrynMawr</span>, and it can source a BC replication stream to <span class="italicunderline">Newtown</span>, which can in turn source a BC replication stream to Oxford. Thus, none of <span class="underline">Malvern</span>, <span class="italicunderline">Newtown</span> or Oxford can source an SI replication stream.</p>
<p>Also an instance can only receive a single SI replication stream. <span class="underline">Malvern</span> cannot receive SI replication from an instance other than <span class="bold"><strong>Ardmore</strong></span> (or an instance receiving BC replication from <span class="bold"><strong>Ardmore</strong></span>, such as <span class="italic">BrynMawr</span>). <span class="italicunderline">Newtown</span> or Oxford are replicating secondary instances and can receive no updates other than from <span class="underline">Malvern</span>.</p>
<p>The total number of replication streams that an instance can source is sixteen, with any combination of BC and SI replication.</p>
</div>
<div class="sect2">
<div class="titlepage"><div><div><h3 class="title">
<a name="Replication_Architecture"></a>Replication Architecture<a class="indexterm" name="idp69902864"></a>
<a class="indexterm" name="idp69690000"></a>
</h3></div></div></div>
<p>The following diagram illustrates a BC replication configuration deployed as B&#8592;A&#8594;C. White (top) is the originating instance processing business logic, while Rose (left) and Yellow (right) are replicating instances. The dotted line represents a TCP connection and the red dots show the movement of transactions.  If White goes down in an unplanned or planned event, either Rose or Yellow can become the originating instance within seconds to tens of seconds, and the other instance can become a replicating instance to the new originating instance. When White recovers, it rejoins as a replicating instance to the new originating instance. At some suitable future time, when so desired, White can again be made the originating instance.</p>
<p>

<img src="ao_figures/repl_anim.gif" height="700">
</p>
<a class="indexterm" name="idp69938368"></a><a class="indexterm" name="idp69859200"></a><a class="indexterm" name="idp69859712"></a><a class="indexterm" name="idp69889552"></a><p>When a process commits a transaction on White, GT.M provides Durability by writing and "hardening" an update record to the journal file and then the database file. The same process also writes the update records to an area of shared memory called a Replication Journal Pool as part of committing the transaction, but does not wait for Rose and Yellow to commit the transaction (this means that a failure of the network between instances does not stop application operation on White). Two Source Server processes, one for Rose and one for Yellow, read journal update records from the Replication Journal Pool and stream updates over TCP connections to Receiver Server processes on the replicating instances they serve.</p>
<p>Under normal conditions, White Source Servers stream update records from the Replication Journal Pool to the Rose and Yellow Receiver Servers. The Replication Journal Pool is a shared memory segment that does not expand after its initial creation. If updates for the database state to which the replicating instance needs to catch up are no longer in the Replication Journal Pool, the Source Server finds the updates in journal files, until the replicating instance catches up to the point where the remaining required updates can again come from the Replication Journal Pool. The diagram represents this with the curved lines from the journal file to the Source Server processes.</p>
<p>A Source Server  can be in either of two modes--active mode or passive mode.  </p>
<p>In active mode, a Source Server connects to the Receiver Server on its replicating instance and transfers update records from the Replication Journal Pool via the communication channel. If an active Source Server is not connected to its Receiver Server, it makes repeated attempts to connect until it succeeds. When an active Source Server connects with its Receiver Server, they ensure their two instances are in sync before proceeding with replication. In the diagram, the White Source Servers are in active mode. When an active Source Server receives a command to switch to passive mode, it closes the connection with its Receiver Server and "goes to sleep" until it receives a command to become active.</p>
<p>In passive mode, a Source Server is in a stand-by state. </p>
<p>On a primary instance, the first active Source Server creates the Replication Journal Pool before beginning to transmit updates to the secondary instance. Transition an active Source Server of a primary to passive when you want to pause replicating updates to the secondary instance but continue performing updates on the primary. When you are ready to resume replicating updates from the primary, transition the passive Source Server to active.</p>
<p>Replication requires each instance to have its own Replication Journal Pool. Additionally, an instance that receives a replication stream must have its own Receiver Pool. </p>
<p>On a secondary instance, the Receiver Server creates the Receiver Pool and a passive Source Server (pointing to either a replicating instance downstream or a dummy (non-existing) replicating instance when there is no replicating instance downstream) creates the Replication Journal Pool. White, Rose, and Yellow can be appropriate names of replication instances in the diagram. The passive Source Servers of Rose and Yellow instances both point to a dummy instance as there are no replicating instances downstream.   </p>
<p>On Rose and Yellow instances, a Receiver Server receives update records sent by the White Source Server and puts them in the Receiver Pool, which is in a shared memory segment. Source and Receiver Server processes implement flow control to ensure that the Receiver Pool does not overflow.  The Update Process picks these update records and writes them to the journal file, the database file, and the Replication Journal Pool. The Update Process on a replicating instance performs operations analogous to "Application Logic" on the originating instance.</p>
<p>Under typical operating conditions, with no system or network bottlenecks, GT.M moves a transaction off the originating instance and into the care of the network moving towards its replicating instance in sub-millisecond time frames. Network transit times then determine how long the transaction message takes to reach the replicating instance. Because it uses a change- or delta-based protocol, GT.M Replication uses network bandwidth efficiently which makes GT.M less resource intensive than physical replication solutions. Furthermore, the Source Server can compress the byte stream which the Receiver Server then decompresses; alternatively network routers can perform the compression and decompression.  When starting replication, you can enable TLS replication to secure replication between instances. Alternatively, you can use standard techniques at the stack or router for encrypting TCP connections to secure the replication stream.</p>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="helper_processes"></a>Helper Processes<a class="indexterm" name="idp69896096"></a>
</h4></div></div></div>
<p>Helper processes accelerate the rate at which an Update Process can apply an incoming replication stream to the database on a replicating instance. They increase replication throughput, decrease backlog, and improve manageability.</p>
<p>The GT.M database engine performs best when multiple processes concurrently access the database, cooperating with one another to manage it. Therefore, it is possible for the tens, hundreds or thousands of application processes executing on an originating instance to outperform a replicating instance with only a single Update Process. Helper processes enable the update process to apply database updates faster and thereby keep up.</p>
<p>There are two types of helper processes: </p>
<a class="indexterm" name="idp69981600"></a><a class="indexterm" name="idp69982368"></a><div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><p>Reader: Reader processes read the update records in the Receive Pool and attempt to pre-fetch database blocks into the global buffer pools, so they are more quickly available for the Update Process.</p></li>
<li class="listitem"><p>Writer: Writer processes help the Update Process by flushing database and journal records from shared memory (global and journal buffers) to the file system.</p></li>
</ol></div>
<p>A certain number of each type of helper process maximizes throughput. As a practical matter, as long as the file system bandwidth on a replicating instance is equal to or greater than that of the originating instance providing its replication stream, there need be little concern about having too many helper processes.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Note]" src="images/note.jpg"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top">
<p>There may be other reasons for a replicating instance to lag behind its originating instance during replication. Helper processes cannot improve situations such as the following:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>There is a bottleneck in the network between the originating and replicating instances--increase the network bandwidth or use compression.</p></li>
<li class="listitem"><p>The hardware of the replicating instance is not as capable as that of the hardware on the originating instance--upgrade the hardware of the replicating instance.</p></li>
</ul></div>
</td></tr>
</table></div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="Filters"></a>Filters<a class="indexterm" name="idp69957856"></a><a class="indexterm" name="idp69767888"></a>
</h4></div></div></div>
<p>A Filter is a conversion program that transforms a replication stream to a desired schema.  It operates as a traditional UNIX filter, reading from STDIN and writing to STDOUT.  Both input and output use the GT.M journal extract format. A filter can operate on an originating instance or a replicating instance. When the originating instance is an older application version, a filter can change the update records from the old schema to the new schema.  When the originating instance is the newer application version, a filter can change the update records from the new schema to the old schema. Once you have logic for converting records in the old schema to the new schema, the per record code serves as the basis for the filter by replacing the scanning logic with logic to read the extract format and extract the update and completing the filter by reassembling the revised record(s) into the GT.M extract format.</p>
<p>For complete redundancy during rolling upgrades, you must also have a filter that changes transactions from the new schema to the old schema.  The principal restriction in creating schema change filters is that the filter must not change the number of transactions in the replication stream, since GT.M uses the journal sequence numbers for checking and restoring the logical equivalence of instances.</p>
<p>This means:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem"><p>If a replication stream contains transactions, for each input transaction, the filter must produce one and exactly one output transaction.  It's acceptable for a transaction to be empty, that is, to make no database updates.</p></li>
<li class="listitem"><p>If an update in a replication stream is outside a transaction, it is considered a transaction in that the journal sequence number is to be incremented by one.</p></li>
<li class="listitem"><p>If the schema change requires a single database update, simply emit the new update in the output stream.</p></li>
<li class="listitem"><p>If the schema change requires no database updates in the new schema, emit a single empty transaction.</p></li>
<li class="listitem"><p>If the schema change requires multiple database updates in the new schema, create a transaction, and package all the updates inside that transaction.</p></li>
</ul></div>
</div>
<div class="sect3">
<div class="titlepage"><div><div><h4 class="title">
<a name="repl_instance_file"></a>Replication Instance File<a class="indexterm" name="idp69978288"></a><a class="indexterm" name="idp70000640"></a>
</h4></div></div></div>
<p>A Replication Instance file maintains the current state of an instance. It also serves as a repository of the history of the journal sequence numbers that are generated locally or received from other instances.</p>
<p>It includes 3 sections --  File Header, Source Server slots, and History Records.</p>
<p>The File Header section records information about the current instance, such as semaphore and shared memory ids of the Journal and Receive Pool, journal sequence number of the current instance.</p>
<p>The Source Server slots store information for each replicating instance for which a Source Server is started. A slot stores the name of the replicating instance, the last transmitted sequence number, and the sequence number when the Source Server was last connected to the originating instance (Connect Sequence Number).</p>
<p>A Replication Instance file has 16 slots. Initially, all are unused. A Source Server replicating to a replicating instance for the first time utilizes an unused slot to store the information and any future Source Server process replicating to the same replicating instance updates this information.</p>
<p>If an unused slot is not available, the first time a Source Server is started to replicate to an instance, the slot for the least recently started replicating instance is reused, and the information that is previously stored in that slot is overwritten. Any subsequent mupip replic -source on the preempted replicating instance generates a REPLINSTSECNONE message.</p>
<p>Preemption of slots does not occur if an instance connects to no more than 16 different replicating instances throughout its lifetime.</p>
<a class="indexterm" name="idp70004176"></a><p>In the History Records section, GT.M maintains the history of on instance as a set of records. GT.M adds new history records to the tail of the instance file whenever an instance changes from being an originating instance to replicating instance or vice versa. The only exception being when MUPIP JOURNAL -ROLLBACK removes history records for rolled back updates from the tail of the instance file. Every record identifies a range of journal sequence numbers and the name of the originating instance that generated those journal records. The first history record starts with the current journal sequence number of the instance.</p>
<p>When an originating instance transmits a sequence number to a replicating instance, GT.M records the originating instance name as "Root Primary Instance Name" in the replication instance file history of both the instances. The same rule applies when a replicating instance acts as an originating instance for another replicating instance downstream.</p>
<p>This history serves to determine the journal sequence numbers through which both instances are synchronized when two instances attempt to connect. GT.M determines this journal sequence number by going back in the history of both the instance files to find the most recent shared journal sequence number generated by the Originating Instance. If the shared journal sequence number matches the current journal sequence number of the Replicating Instance, the Receiver Server on the replicating instance continues with normal replication.  Otherwise, a synchronization requires a MUPIP JOURNAL -ROLLBACK -FETCHRESYNC, or if configured, an autorollback on the Replicating Instance to rollback to a common synchronization point from which the originating instance can transmit updates to allow the Replicating Instance to catch up.</p>
<a class="indexterm" name="idp70007312"></a><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Note">
<tr>
<td rowspan="2" align="center" valign="top" width="12pt"><img alt="[Note]" src="images/note.jpg"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top"><p>Proper operation requires the Replication Instance file be consistent with the snapshot of the database files in a backup. MUPIP BACKUP -REPLINSTANCE creates a backup of the Replication Instance file.  Before backing up the replication instance file, you must start the Source Server for the instance at least once . If the replication instance file is damaged or deleted, you must create a new instance file, and all recreate all downstream Replicating Instances from backups. </p></td></tr>
</table></div>
</div>
</div>
<div class="footnotes">
<br><hr width="100" align="left">
<div class="footnote"><p><sup>[<a name="ftn.idp69313136" href="ch07s01.html#idp69313136" class="para">1</a>] </sup>GT.M database replication is compatible with clustering - each instance can be a "hot-warm" cluster where if one node fails, another node can recover the database and continue operation. Since GT.M LMS application configurations provides better business continuity in the face of a greater range of eventualities than clusters, if you wish to use clusters, consider their use in conjunction with, rather than instead of, GT.M LMS  configurations.</p></div>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="ch07.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="u" href="ch07.html">Up</a></td>
<td width="40%" align="right"> <a accesskey="n" href="ch07s02.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left" valign="top">Chapter 7. Database Replication </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right" valign="top"> Implementing Replication and Recovery</td>
</tr>
</table>
</div>
</body>
</html>
